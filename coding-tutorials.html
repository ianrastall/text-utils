<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coding Tutorials</title>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0V2F0V7FWB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-0V2F0V7FWB');
    </script>

    <!-- Core CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/custom.css?v=1.1">
    <link rel="stylesheet" href="css/tutorials.css?v=1.5">

    <!-- Markdown-it (client-side Markdown to HTML) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>

    <!-- Highlight.js for syntax highlighting -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github-dark.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/ada.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/x86asm.min.js"></script>
	<script>hljs.highlightAll();</script>
    <!-- Theme CSS Variables -->
    <style>
        :root { --accent-color: burlywood; }
        .theme-burlywood { --accent-color: burlywood; }
        .theme-cadetblue { --accent-color: cadetblue; }
        .theme-cornflowerblue { --accent-color: cornflowerblue; }
        .theme-dodgerblue { --accent-color: dodgerblue; }
        .theme-lightcoral { --accent-color: lightcoral; }
        .theme-lightgreen { --accent-color: lightgreen; }
        .theme-plum { --accent-color: plum; }
        .theme-thistle { --accent-color: thistle; }
        .theme-tomato { --accent-color: tomato; }
        .theme-violet { --accent-color: violet; }
        
        /* Ensure dropdown is always on top */
        .dropdown-menu { z-index: 1150; }
    </style>
</head>
<body>
    <!-- Header Placeholder -->
    <div id="header-placeholder"></div>

    <!-- Main Content -->
    <div class="container-fluid my-4">
        <div class="row gx-3 gy-3">
            <main class="col-md-9">
                <div class="card bg-dark border-secondary shadow-sm h-100">
                    <div class="card-body d-flex flex-column">
                        <!-- Dynamic Title -->
                        <div class="d-flex align-items-center mb-3">
                            <span class="material-icons me-3" aria-hidden="true" style="font-size: 36px;" id="tool-icon">school</span>
                            <h2 class="m-0" id="tool-name">Coding Tutorials</h2>
                        </div>
                        <p class="text-white-50 mb-4" id="tool-description">Learn programming languages through interactive examples and exercises.</p>

                        <!-- Tutorial Navigation -->
                        <div class="tutorial-nav mb-4">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <select class="form-select bg-dark text-light border-secondary" id="languageSelect">
                                        <option value="">Select a Language...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <select class="form-select bg-dark text-light border-secondary" id="topicSelect" disabled>
                                        <option value="">Select a Topic...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Tutorial Content -->
                        <div id="mainOutput" class="tutorial-content flex-grow-1">
                            <div class="text-white-50 text-center p-5">
                                Select a language and topic to begin learning
                            </div>
                        </div>

                        <!-- Tutorial Controls -->
                        <div class="tutorial-controls mt-3">
                            <button id="copyBtn" class="btn btn-outline-primary" disabled>
                                <i class="material-icons">content_copy</i> Copy Content
                            </button>
                            <button id="resetBtn" class="btn btn-outline-secondary">
                                <i class="material-icons">refresh</i> Reset
                            </button>
                        </div>
                    </div>
                </div>
            </main>
            
            <aside class="col-md-3">
                <div class="card bg-dark border-secondary">
                    <div class="card-body p-0">
                        <nav class="sidebar nav flex-column" id="dynamic-sidebar">
                        </nav>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>
    
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/component-loader.js"></script>

<script>
// Maps folder names to display names for the language dropdown.
// This is the only mapping you need to maintain.
const languageNames = {
    ada: 'Ada',
    asm: 'Assembly'
};

let currentRawContent = '';
let currentIsMarkdown = false;

// DOM element references
const languageSelect = document.getElementById('languageSelect');
const topicSelect = document.getElementById('topicSelect');
const mainOutput = document.getElementById('mainOutput');
const copyBtn = document.getElementById('copyBtn');
const resetBtn = document.getElementById('resetBtn');

// Finds tutorial files by checking for their existence in a sequence.
// Assumes files are named `tutorial-{language}-{number}.md`.
async function discoverTutorialFiles(language) {
    const files = [];
    // We'll check for up to 30 sequential files.
    // The loop stops if a file is not found, so it doesn't make unnecessary requests.
    for (let i = 1; i <= 30; i++) {
        const fileNum = i.toString().padStart(2, '0'); // Formats numbers as 01, 02, etc.
        const fileName = `tutorial-${language}-${fileNum}.md`;
        
        try {
            // Use a 'HEAD' request which is lightweight as it only fetches headers.
            const response = await fetch(`tutorials/${language}/${fileName}`, { method: 'HEAD' });
            if (response.ok) {
                files.push(fileName);
            } else {
                // If we find a gap in the sequence (e.g., no file #5), stop looking.
                break;
            }
        } catch (e) {
            // Stop if there's a network error.
            break;
        }
    }
    return files;
}

// Loads the content of a specific tutorial file.
async function loadTutorialContent(language, fileName) {
    try {
        const path = `tutorials/${language}/${fileName}`;
        const response = await fetch(path);
        if (!response.ok) {
            throw new Error(`File not found at ${path}`);
        }
        
        const rawContent = await response.text();
        
        // Render Markdown to HTML using the markdown-it library
        const md = window.markdownit({
            html: true,
            linkify: true,
            typographer: true
        });

        return {
            html: md.render(rawContent),
            raw: rawContent,
            isMarkdown: true
        };
        
    } catch (error) {
        console.error('Error loading tutorial content:', error);
        showToast('Failed to load tutorial content', 'danger');
        return null;
    }
}

// Displays the selected tutorial section in the main content area.
async function displayTutorialSection(language, fileName) {
    // Show a loading state
    mainOutput.innerHTML = `<div class="text-white-50 text-center p-5">
        <div class="spinner-border text-secondary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Loading tutorial content...</p>
    </div>`;
    
    const content = await loadTutorialContent(language, fileName);
    
    if (!content) {
        mainOutput.innerHTML = `<span class="text-white-50">Tutorial section not found.</span>`;
        currentRawContent = '';
        copyBtn.disabled = true;
        return;
    }

    mainOutput.innerHTML = content.html;
    currentRawContent = content.raw;
    currentIsMarkdown = content.isMarkdown;
    copyBtn.disabled = false;
    
    // Re-apply syntax highlighting to the new content
    hljs.highlightAll();
}

// Populates the languages dropdown from the `languageNames` object.
function populateLanguages() {
    languageSelect.innerHTML = '<option value="">Select a Language...</option>';
    
    Object.entries(languageNames).forEach(([key, name]) => {
        const option = new Option(name, key);
        languageSelect.appendChild(option);
    });
}

// Dynamically populates the topics dropdown based on the selected language.
async function populateTopics(language) {
    topicSelect.innerHTML = '<option value="">Loading Topics...</option>';
    topicSelect.disabled = true;
    
    if (!language) {
        topicSelect.innerHTML = '<option value="">Select a Topic...</option>';
        return;
    }
    
    // Find all tutorial files for the selected language.
    const fileList = await discoverTutorialFiles(language);
    
    if (fileList.length === 0) {
        topicSelect.innerHTML = '<option value="">No topics found</option>';
        return;
    }

    // Fetch the first line of each file to use as the title.
    const topicPromises = fileList.map(async (fileName) => {
        try {
            const response = await fetch(`tutorials/${language}/${fileName}`);
            const content = await response.text();
            const firstLine = content.split('\n')[0] || 'Untitled';
            
            // Start with the basic cleaned title
            let title = firstLine.replace(/^#\s*/, '').trim();

            // --- CHANGES ARE HERE ---

            // 1. Truncate the title at the colon, if one exists.
            const colonIndex = title.indexOf(':');
            if (colonIndex > -1) {
                title = title.substring(0, colonIndex).trim();
            }

            // 2. Remove any backslash escapes before a dot (e.g., "1\." becomes "1.").
            title = title.replace(/\\\./g, '.');
            
            // --- END OF CHANGES ---

            return { value: fileName, text: title };
        } catch {
            return { value: fileName, text: fileName }; // Fallback to filename
        }
    });

    const topics = await Promise.all(topicPromises);

    // Populate the dropdown with the discovered topics.
    topicSelect.innerHTML = '<option value="">Select a Topic...</option>';
    topics.forEach(topic => {
        // The display text is the title, and the option's value is the filename.
        const option = new Option(topic.text, topic.value);
        topicSelect.appendChild(option);
    });
    
    topicSelect.disabled = false;
}

// Event Listeners
languageSelect.addEventListener('change', (e) => {
    const language = e.target.value;
    populateTopics(language);
    mainOutput.innerHTML = '<div class="text-white-50 text-center p-5">Select a topic to begin learning</div>';
    copyBtn.disabled = true;
});

topicSelect.addEventListener('change', async (e) => {
    const fileName = e.target.value; // The value is now the filename
    const language = languageSelect.value;
    
    if (fileName && language) {
        await displayTutorialSection(language, fileName);
    } else {
        mainOutput.innerHTML = '<div class="text-white-50 text-center p-5">Select a topic to begin learning</div>';
        copyBtn.disabled = true;
    }
});

copyBtn.addEventListener('click', () => {
    if (!currentRawContent) return;
    
    navigator.clipboard.writeText(currentRawContent).then(() => {
        showToast('Tutorial content copied to clipboard as Markdown!', 'success');
    }).catch(err => {
        showToast('Failed to copy content', 'danger');
    });
});

resetBtn.addEventListener('click', () => {
    languageSelect.value = '';
    populateTopics('');
    mainOutput.innerHTML = '<div class="text-white-50 text-center p-5">Select a language and topic to begin learning</div>';
    currentRawContent = '';
    copyBtn.disabled = true;
});

// Toast notification utility
function showToast(message, variant = 'info') {
    const toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    toastContainer.style.zIndex = '1100';

    const toastEl = document.createElement('div');
    toastEl.className = `toast align-items-center text-bg-${variant} border-0`;
    toastEl.setAttribute('role', 'alert');
    toastEl.setAttribute('aria-live', 'assertive');
    toastEl.setAttribute('aria-atomic', 'true');

    const toastBody = document.createElement('div');
    toastBody.className = 'toast-body';
    toastBody.textContent = message;

    const closeButton = document.createElement('button');
    closeButton.type = 'button';
    closeButton.className = 'btn-close btn-close-white me-2 m-auto';
    closeButton.setAttribute('data-bs-dismiss', 'toast');
    closeButton.setAttribute('aria-label', 'Close');
    
    const flexContainer = document.createElement('div');
    flexContainer.className = 'd-flex';
    flexContainer.appendChild(toastBody);
    flexContainer.appendChild(closeButton);
    toastEl.appendChild(flexContainer);

    document.body.appendChild(toastContainer);
    toastContainer.appendChild(toastEl);
    
    const toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 3000 });
    toast.show();
    toastEl.addEventListener('hidden.bs.toast', () => { toastContainer.remove(); });
}

// Theme switcher initialization (assuming it's part of your component loader)
function initThemeSwitcher() {
    const themes = ['burlywood', 'cadetblue', 'cornflowerblue', 'dodgerblue', 
                  'lightcoral', 'lightgreen', 'plum', 'thistle', 'tomato', 'violet'];
    const themeDropdown = document.getElementById('accentColorDropdownMenu');
    const htmlElement = document.documentElement;

    function clearThemeClasses() {
        const classList = Array.from(htmlElement.classList);
        classList.forEach(className => {
            if (className.startsWith('theme-')) {
                htmlElement.classList.remove(className);
            }
        });
    }

    function applyTheme(theme) {
        clearThemeClasses();
        htmlElement.classList.add('theme-' + theme);
        localStorage.setItem('accentTheme', theme);
    }

    if (themeDropdown) {
        themes.forEach(theme => {
            const li = document.createElement('li');
            const button = document.createElement('button');
            button.className = 'dropdown-item';
            button.type = 'button';
            button.textContent = theme;
            button.onclick = () => applyTheme(theme);
            li.appendChild(button);
            themeDropdown.appendChild(li);
        });
    }

    const savedTheme = localStorage.getItem('accentTheme') || themes[0];
    applyTheme(savedTheme);
}

// Initialize page metadata from a config file
async function initPageMetadata() {
    const currentSlug = 'code-tutorials';
    try {
        const response = await fetch('config/tools.json');
        if (!response.ok) throw new Error('Failed to load tools.json');
        const tools = await response.json();
        const currentTool = tools.find(tool => tool.slug === currentSlug) || {};
        document.getElementById('tool-name').textContent = currentTool.name || 'Coding Tutorials';
        document.getElementById('tool-description').textContent = currentTool.description || 'Reference guides and examples...';
        const iconEl = document.getElementById('tool-icon');
        if (currentTool.icon) {
            if (currentTool.icon.endsWith('.svg') || currentTool.icon.endsWith('.png')) {
                iconEl.outerHTML = `<img src="${currentTool.icon}" alt="" style="height: 36px; margin-right: 15px;" id="tool-icon" aria-hidden="true" />`;
            } else {
                iconEl.textContent = currentTool.icon;
            }
        }
        const sidebarHtml = tools
            .sort((a, b) => a.name.localeCompare(b.name))
            .map(tool => {
                const isActive = tool.slug === currentSlug;
                const activeClass = isActive ? ' active' : '';
                const iconHtml = tool.icon && (tool.icon.endsWith('.svg') || tool.icon.endsWith('.png'))
                    ? `<img src="${tool.icon}" alt="" style="width: 24px; height: 24px;" aria-hidden="true" />`
                    : `<i class="material-icons" aria-hidden="true">${tool.icon || 'school'}</i>`;
                
                return `<a class="nav-link${activeClass}" href="${tool.slug}.html">${iconHtml} ${tool.name}</a>`;
            }).join('');
        document.getElementById('dynamic-sidebar').innerHTML = sidebarHtml;
    } catch (error) {
        console.error('Error initializing page meta:', error);
    }
}

// Initialize everything when the page loads
document.addEventListener('DOMContentLoaded', async function () {
    // Load header and footer components
    await ComponentLoader.loadAll();
    
    // Initialize theme switcher (must run after header is loaded)
    initThemeSwitcher();
    
    // Initialize page metadata
    await initPageMetadata();
    
    // Populate the initial language dropdown
    populateLanguages();
});
    </script>
</body>
</html>