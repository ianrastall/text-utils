<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag gtag.js -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0V2F0V7FWB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0V2F0V7FWB');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Tool - Text Utilities</title>
    <script>
        (function () {
            try {
                const storedTheme = localStorage.getItem('theme');
                const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
                const resolvedTheme = storedTheme === 'light' || storedTheme === 'dark'
                    ? storedTheme
                    : (prefersLight ? 'light' : 'dark');
                document.documentElement.setAttribute('data-theme', resolvedTheme);

                const storedAccent = localStorage.getItem('accentColor');
                let normalizedAccent = typeof storedAccent === 'string' ? storedAccent.trim().toLowerCase() : '';
                if (/^#[0-9a-f]{3}$/.test(normalizedAccent)) {
                    normalizedAccent = `#${normalizedAccent[1]}${normalizedAccent[1]}${normalizedAccent[2]}${normalizedAccent[2]}${normalizedAccent[3]}${normalizedAccent[3]}`;
                }

                if (/^#[0-9a-f]{6}$/.test(normalizedAccent)) {
                    const red = parseInt(normalizedAccent.slice(1, 3), 16);
                    const green = parseInt(normalizedAccent.slice(3, 5), 16);
                    const blue = parseInt(normalizedAccent.slice(5, 7), 16);
                    document.documentElement.style.setProperty('--accent', normalizedAccent);
                    document.documentElement.style.setProperty('--accent-rgb', `${red}, ${green}, ${blue}`);
                }
            } catch (_) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .mode-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .mode-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mode-tab:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .mode-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .error-panel {
            background: var(--bg-tertiary);
            border-left: 3px solid var(--error);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            display: none;
        }

        .error-panel.show {
            display: block;
        }

        .error-title {
            color: var(--error);
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .error-message {
            color: var(--text-primary);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.875rem;
        }

        .info-panel {
            background: var(--bg-tertiary);
            border-left: 3px solid var(--accent);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .info-panel h4 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .example-badge {
            display: inline-block;
            background: var(--accent);
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        .json-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <a href="index.html" style="color: inherit; text-decoration: none;">
                    <span>Text Utilities</span>
                </a>
            </div>
            <nav class="site-network" aria-label="Network sites">
                <a href="https://chessnerd.net" class="site-network-link" target="_blank" rel="noopener noreferrer">
                    <img src="img/chessnerd-icon.png" class="site-network-icon" alt="">
                    <span>Chess Nerd</span>
                    <span class="material-icons" aria-hidden="true">open_in_new</span>
                </a>
                <a href="https://github.com/ianrastall/text-utils" class="site-network-link" target="_blank" rel="noopener noreferrer">
                    <img src="img/github.png" class="site-network-icon" alt="">
                    <span>GitHub</span>
                    <span class="material-icons" aria-hidden="true">open_in_new</span>
                </a>
            </nav>
            <div class="controls">
                <div class="accent-selector">
                    <span class="material-icons">palette</span>
                    <select id="accentColor" class="color-dropdown" aria-label="Accent color"></select>
                </div>
                <button id="themeToggle" class="btn btn-secondary" type="button" aria-label="Toggle theme" aria-pressed="false">
                    <span class="material-icons">dark_mode</span>
                </button>
            </div>
        </header>

                <main>
            <div class="tool-container">
                <div class="tool-header">
                    <div class="tool-title">
                        <span class="material-icons">data_object</span>
                        <h2>JSON Tool</h2>
                    </div>
                    <div class="tool-actions">
                        <button id="backButton" class="btn btn-secondary btn-compact" type="button">
                            <span class="material-icons">arrow_back</span>
                            Back
                        </button>
                        <button id="exampleBtn" class="btn btn-secondary" type="button">
                            <span class="material-icons">science</span>
                            Example
                        </button>
                        <button id="copyOutput" class="btn btn-secondary btn-compact" type="button">
                            <span class="material-icons">content_copy</span>
                            Copy
                        </button>
                        <button id="clearBtn" class="btn btn-secondary" type="button">
                            <span class="material-icons">clear</span>
                            Clear
                        </button>
                        <button id="processBtn" class="btn btn-primary" type="button">
                            <span class="material-icons">play_arrow</span>
                            <span id="processLabel">Format</span>
                        </button>
                    </div>
                </div>

                <p class="tool-description">Format, validate, and convert JSON to JSONL format</p>

                <div class="mode-tabs" role="tablist" aria-label="JSON tool mode">
                    <button class="mode-tab active" data-mode="format" type="button" role="tab" aria-selected="true" tabindex="0">
                        <span class="material-icons">code</span>
                        Format JSON
                    </button>
                    <button class="mode-tab" data-mode="jsonl" type="button" role="tab" aria-selected="false" tabindex="-1">
                        <span class="material-icons">view_list</span>
                        JSON to JSONL
                    </button>
                    <button class="mode-tab" data-mode="validate" type="button" role="tab" aria-selected="false" tabindex="-1">
                        <span class="material-icons">check_circle</span>
                        Validate Only
                    </button>
                </div>

                <div class="info-panel">
                    <h4>
                        <span class="material-icons">info</span>
                        <span id="infoTitle">JSON Formatting</span>
                    </h4>
                    <p id="infoText">
                        Format and validate JSON with customizable indentation. 
                        Automatically detects syntax errors and provides helpful error messages.
                    </p>
                </div>

                <div class="error-panel" id="errorPanel" role="alert" aria-live="assertive" aria-hidden="true">
                    <div class="error-title">
                        <span class="material-icons">error</span>
                        <span>Syntax Error</span>
                    </div>
                    <div class="error-message" id="errorMessage"></div>
                </div>

                <div class="json-stats" id="statsPanel" style="display: none;">
                    <div class="stat-item">
                        <span class="stat-label">Objects</span>
                        <span class="stat-value" id="statObjects">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Arrays</span>
                        <span class="stat-value" id="statArrays">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Keys</span>
                        <span class="stat-value" id="statKeys">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Max Depth</span>
                        <span class="stat-value" id="statDepth">0</span>
                    </div>
                </div>

                <div class="options-panel" id="optionsPanel">
                    <div class="options-grid">
                        <div class="option-group">
                            <label for="indentSelect">Indentation</label>
                            <select id="indentSelect">
                                <option value="2">2 spaces</option>
                                <option value="4">4 spaces</option>
                                <option value="tab">Tab</option>
                                <option value="0">Minified</option>
                            </select>
                        </div>
                        <div class="option-group">
                            <label for="sortKeysCheck">
                                <input type="checkbox" id="sortKeysCheck">
                                Sort object keys alphabetically
                            </label>
                        </div>
                    </div>
                </div>

                <div class="io-container">
                    <div class="io-panel">
                        <div class="io-label">
                            <span>Input JSON</span>
                            <span class="stats pill muted" id="inputStats">0 chars</span>
                        </div>
                        <textarea id="inputText" placeholder='{"name": "John", "age": 30, "city": "New York"}'></textarea>
                    </div>
                    <div class="io-panel">
                        <div class="io-label">
                            <span id="outputLabel">Formatted Output</span>
                            <span class="stats pill muted" id="outputStats">0 chars</span>
                        </div>
                        <textarea id="outputText" class="output" readonly placeholder="Processed output will appear here..."></textarea>
                    </div>
                </div>

                <div class="status-bar">
                    <div id="statusMessage" class="success" role="status" aria-live="polite">Ready</div>
                    <div id="processingTime">No operations yet</div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/theme.js"></script>
    <script>
        'use strict';

        // DOM Elements
        const inputText = document.getElementById('inputText');
        const outputText = document.getElementById('outputText');
        const processBtn = document.getElementById('processBtn');
        const processLabel = document.getElementById('processLabel');
        const copyBtn = document.getElementById('copyOutput');
        const clearBtn = document.getElementById('clearBtn');
        const exampleBtn = document.getElementById('exampleBtn');
        const backBtn = document.getElementById('backButton');
        const modeTabs = document.querySelectorAll('.mode-tab');
        const indentSelect = document.getElementById('indentSelect');
        const sortKeysCheck = document.getElementById('sortKeysCheck');
        const errorPanel = document.getElementById('errorPanel');
        const errorMessage = document.getElementById('errorMessage');
        const statsPanel = document.getElementById('statsPanel');
        const optionsPanel = document.getElementById('optionsPanel');
        const infoTitle = document.getElementById('infoTitle');
        const infoText = document.getElementById('infoText');
        const outputLabel = document.getElementById('outputLabel');
        const statusMessage = document.getElementById('statusMessage');
        const processingTime = document.getElementById('processingTime');
        const inputStats = document.getElementById('inputStats');
        const outputStats = document.getElementById('outputStats');
        const statObjects = document.getElementById('statObjects');
        const statArrays = document.getElementById('statArrays');
        const statKeys = document.getElementById('statKeys');
        const statDepth = document.getElementById('statDepth');

        // State
        let currentMode = 'format';
        const MAX_INPUT_CHARACTERS = 5 * 1024 * 1024;
        const MAX_RECURSION_DEPTH = 1000;

        // Mode Information
        const modeInfo = {
            format: {
                title: 'JSON Formatting',
                text: 'Format and validate JSON with customizable indentation. Automatically detects syntax errors and provides helpful error messages.',
                outputLabel: 'Formatted Output'
            },
            jsonl: {
                title: 'JSON to JSONL Conversion',
                text: 'Convert JSON arrays to JSON Lines format (JSONL). Each array element becomes a separate line of valid JSON. Perfect for streaming data and big data processing.',
                outputLabel: 'JSONL Output'
            },
            validate: {
                title: 'JSON Validation',
                text: 'Validate JSON syntax and structure. Shows detailed error messages with line and column numbers. Also provides statistics about your JSON structure.',
                outputLabel: 'Validation Result'
            }
        };

        // Example JSON
        const exampleJSON = {
            users: [
                {
                    id: 1,
                    name: "Alice Johnson",
                    email: "alice@example.com",
                    age: 28,
                    active: true
                },
                {
                    id: 2,
                    name: "Bob Smith",
                    email: "bob@example.com",
                    age: 34,
                    active: false
                },
                {
                    id: 3,
                    name: "Carol White",
                    email: "carol@example.com",
                    age: 31,
                    active: true
                }
            ],
            metadata: {
                total: 3,
                page: 1,
                timestamp: "2024-01-15T10:30:00Z"
            }
        };

        // Mode switching
        function setActiveTab(activeTab) {
            modeTabs.forEach(tab => {
                const isActive = tab === activeTab;
                tab.classList.toggle('active', isActive);
                tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
                tab.setAttribute('tabindex', isActive ? '0' : '-1');
            });
        }

        modeTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                setActiveTab(tab);
                currentMode = tab.dataset.mode;
                updateModeUI();
            });
        });

        modeTabs.forEach((tab, index) => {
            tab.addEventListener('keydown', event => {
                if (!['ArrowLeft', 'ArrowRight', 'Home', 'End'].includes(event.key)) {
                    return;
                }

                event.preventDefault();
                let nextIndex = index;
                if (event.key === 'ArrowRight') {
                    nextIndex = (index + 1) % modeTabs.length;
                } else if (event.key === 'ArrowLeft') {
                    nextIndex = (index - 1 + modeTabs.length) % modeTabs.length;
                } else if (event.key === 'Home') {
                    nextIndex = 0;
                } else if (event.key === 'End') {
                    nextIndex = modeTabs.length - 1;
                }

                const nextTab = modeTabs[nextIndex];
                nextTab.focus();
                nextTab.click();
            });
        });

        function updateModeUI() {
            const info = modeInfo[currentMode];
            if (!info) {
                throw new Error(`Unknown mode: ${currentMode}`);
            }

            infoTitle.textContent = info.title;
            infoText.textContent = info.text;
            outputLabel.textContent = info.outputLabel;

            // Show/hide options panel
            optionsPanel.style.display = currentMode === 'format' ? 'block' : 'none';

            // Reset mode-scoped panels so old state is not shown after mode changes.
            hideError();
            hideStats();

            const processIcon = processBtn.querySelector('.material-icons');
            if (currentMode === 'validate') {
                processIcon.textContent = 'check_circle';
                processLabel.textContent = 'Validate';
            } else if (currentMode === 'jsonl') {
                processIcon.textContent = 'play_arrow';
                processLabel.textContent = 'Convert';
            } else {
                processIcon.textContent = 'play_arrow';
                processLabel.textContent = 'Format';
            }
        }

        // JSON Processing Functions
        function analyzeJSON(obj, depth = 0, stats = null) {
            if (depth > MAX_RECURSION_DEPTH) {
                throw new Error(`JSON is nested too deeply to analyze (>${MAX_RECURSION_DEPTH} levels).`);
            }

            if (!stats) {
                stats = { objects: 0, arrays: 0, keys: 0, maxDepth: 0 };
            }
            
            stats.maxDepth = Math.max(stats.maxDepth, depth);
            
            if (Array.isArray(obj)) {
                stats.arrays++;
                obj.forEach(item => analyzeJSON(item, depth + 1, stats));
            } else if (obj !== null && typeof obj === 'object') {
                stats.objects++;
                stats.keys += Object.keys(obj).length;
                Object.values(obj).forEach(value => analyzeJSON(value, depth + 1, stats));
            }
            
            return stats;
        }

        function displayStats(stats) {
            statObjects.textContent = stats.objects;
            statArrays.textContent = stats.arrays;
            statKeys.textContent = stats.keys;
            statDepth.textContent = stats.maxDepth;
            statsPanel.style.display = 'grid';
        }

        function hideStats() {
            statsPanel.style.display = 'none';
        }

        function sortObjectKeys(obj, depth = 0) {
            if (depth > MAX_RECURSION_DEPTH) {
                throw new Error(`JSON is nested too deeply to sort (>${MAX_RECURSION_DEPTH} levels).`);
            }

            if (Array.isArray(obj)) {
                return obj.map(item => sortObjectKeys(item, depth + 1));
            } else if (obj !== null && typeof obj === 'object') {
                return Object.keys(obj)
                    .sort()
                    .reduce((sorted, key) => {
                        sorted[key] = sortObjectKeys(obj[key], depth + 1);
                        return sorted;
                    }, {});
            }
            return obj;
        }

        function formatJSON(input) {
            const parsed = JSON.parse(input);
            const shouldSort = sortKeysCheck.checked;
            const indentValue = indentSelect.value;
            
            let obj = shouldSort ? sortObjectKeys(parsed, 0) : parsed;
            let indent = indentValue === 'tab' ? '\t' : 
                        indentValue === '0' ? 0 : 
                        parseInt(indentValue);
            
            const stats = analyzeJSON(obj);
            displayStats(stats);
            
            return JSON.stringify(obj, null, indent);
        }

        function convertToJSONL(input) {
            const parsed = JSON.parse(input);
            
            if (!Array.isArray(parsed)) {
                throw new Error('Input must be a JSON array for JSONL conversion. Wrap your object in square brackets [] if needed.');
            }
            
            if (parsed.length === 0) {
                throw new Error('Array is empty. Cannot convert to JSONL.');
            }
            
            const stats = analyzeJSON(parsed);
            displayStats(stats);
            
            return parsed.map(item => JSON.stringify(item)).join('\n');
        }

        function validateJSON(input) {
            const parsed = JSON.parse(input);
            const stats = analyzeJSON(parsed);
            displayStats(stats);
            
            const type = parsed === null ? 'null' :
                        Array.isArray(parsed) ? 'Array' :
                        typeof parsed === 'object' ? 'Object' :
                        typeof parsed;
            
            return `âœ“ Valid JSON\n\nType: ${type}\nObjects: ${stats.objects}\nArrays: ${stats.arrays}\nTotal Keys: ${stats.keys}\nMax Depth: ${stats.maxDepth}`;
        }

        function showError(error, sourceText) {
            errorPanel.classList.add('show');
            errorPanel.setAttribute('aria-hidden', 'false');
            
            // Parse error message for better display
            let message = error && error.message ? error.message : String(error);
            let locationText = '';

            const ffLineColMatch = message.match(/line\s+(\d+)\s+column\s+(\d+)/i);
            if (ffLineColMatch) {
                const line = Number(ffLineColMatch[1]);
                const col = Number(ffLineColMatch[2]);
                locationText = `Location: Line ${line}, Column ${col}`;
            } else {
                const posMatch = message.match(/(?:at\s+)?position\s+(\d+)/i);
                if (posMatch && typeof sourceText === 'string') {
                    const pos = Math.max(0, Math.min(sourceText.length, Number(posMatch[1])));
                    const lines = sourceText.substring(0, pos).split('\n');
                    const line = lines.length;
                    const col = lines[lines.length - 1].length + 1;
                    locationText = `Location: Line ${line}, Column ${col}`;
                }
            }

            if (locationText && !message.includes(locationText)) {
                message += `\n\n${locationText}`;
            }
            
            errorMessage.textContent = message;
            hideStats();
        }

        function hideError() {
            errorPanel.classList.remove('show');
            errorPanel.setAttribute('aria-hidden', 'true');
        }

        function processJSON() {
            const rawInput = inputText.value;

            if (rawInput.length > MAX_INPUT_CHARACTERS) {
                outputText.value = '';
                hideError();
                hideStats();
                updateStats();
                showStatus('Input too large (max 5MB).', 'error');
                return;
            }
            
            if (!rawInput.trim()) {
                outputText.value = '';
                hideError();
                hideStats();
                updateStats();
                showStatus('Please enter some JSON to process', 'warning');
                return;
            }

            hideError();
            
            try {
                const startTime = performance.now();
                const parseText = rawInput;
                let result;
                
                switch (currentMode) {
                    case 'format':
                        result = formatJSON(parseText);
                        break;
                    case 'jsonl':
                        result = convertToJSONL(parseText);
                        break;
                    case 'validate':
                        result = validateJSON(parseText);
                        break;
                    default:
                        throw new Error(`Unknown mode: ${currentMode}`);
                }
                
                const endTime = performance.now();
                
                outputText.value = result;
                showStatus('Success!', 'success');
                processingTime.textContent = `Processed in ${Math.round(endTime - startTime)}ms`;
                updateStats();
                
            } catch (error) {
                console.error('Processing error:', error);
                showError(error, rawInput);
                outputText.value = '';
                const errorMessageText = error && error.message ? error.message : String(error);
                showStatus('Error: ' + errorMessageText, 'error');
                processingTime.textContent = 'Processing failed';
            }
        }

        function loadExample() {
            inputText.value = JSON.stringify(exampleJSON, null, 2);
            updateStats();
            showStatus('Example loaded', 'success');
        }

        function clearAll() {
            inputText.value = '';
            outputText.value = '';
            hideError();
            hideStats();
            updateStats();
            showStatus('Cleared', 'success');
        }

        async function copyToClipboard() {
            const text = outputText.value;
            if (!text) {
                showStatus('Nothing to copy', 'warning');
                return;
            }

            try {
                if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                    await window.textUtilsClipboardWrite(text);
                    showStatus('Copied to clipboard!', 'success');
                    return;
                }

                outputText.focus();
                outputText.select();
                const copied = document.execCommand('copy');
                showStatus(copied ? 'Copied to clipboard!' : 'Copy failed', copied ? 'success' : 'error');
            } catch {
                showStatus('Copy failed', 'error');
            }
        }

        function showStatus(message, type = 'success') {
            statusMessage.textContent = message;
            statusMessage.className = type;
        }

        function updateStats() {
            const inputLength = inputText.value.length;
            const outputLength = outputText.value.length;
            const inputLines = inputLength === 0 ? 0 : inputText.value.split('\n').length;
            const outputLines = outputLength === 0 ? 0 : outputText.value.split('\n').length;
            
            inputStats.textContent = `${inputLength} chars, ${inputLines} lines`;
            outputStats.textContent = `${outputLength} chars, ${outputLines} lines`;
        }

        // Event Listeners
        processBtn.addEventListener('click', processJSON);
        copyBtn.addEventListener('click', copyToClipboard);
        clearBtn.addEventListener('click', clearAll);
        exampleBtn.addEventListener('click', loadExample);
        backBtn.addEventListener('click', () => window.location.href = 'index.html');

        inputText.addEventListener('input', updateStats);

        // Keyboard shortcuts
        inputText.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                processJSON();
            }
        });

        // Initialize
        updateStats();
        const initialTab = Array.from(modeTabs).find(tab => tab.dataset.mode === currentMode);
        if (initialTab) {
            setActiveTab(initialTab);
        }
        updateModeUI();
    </script>
    <footer class="site-footer">
        <p>&copy; Ian Rastall 2025<br>Contact: moving.form.of.dust@gmail.com<br>Donate: PayPal to merastall@gmail.com</p>
    </footer>
</body>
</html>
