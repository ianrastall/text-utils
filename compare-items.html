<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compare Items â€“ Text Utils</title>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
</head>
<body class="bg-dark text-light">
    <div id="header-placeholder"></div>
    <div class="container-fluid my-4">
        <div class="row gx-3 gy-3">
            <main class="col-md-9">
                <div class="card bg-dark border-secondary">
                    <div class="card-body" id="compareItemsApp">
                        <h2 class="card-title mb-4 d-flex align-items-center">
                            <span class="material-icons me-3" style="font-size:36px;" aria-hidden="true">compare_arrows</span>
                            Compare Items
                        </h2>
                        <div id="setupStage">
                            <div class="mb-4">
                                <label class="form-label">Tournament Format:</label>
                                <div class="d-flex flex-wrap gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="tournamentFormat" id="formatDouble" value="double" checked>
                                        <label class="form-check-label" for="formatDouble">Double Elimination</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="tournamentFormat" id="formatSingle" value="single">
                                        <label class="form-check-label" for="formatSingle">Single Elimination</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="tournamentFormat" id="formatRound" value="round">
                                        <label class="form-check-label" for="formatRound">Round Robin</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="tournamentFormat" id="formatSwiss" value="swiss">
                                        <label class="form-check-label" for="formatSwiss">Swiss System</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="tournamentFormat" id="formatFree" value="free">
                                        <label class="form-check-label" for="formatFree">Free Selection</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="form-label">Ranking Algorithm:</label>
                                <select class="form-select w-auto" id="algorithmSelect">
                                    <option value="elo">Elo Rating</option>
                                    <option value="glicko">Glicko-2</option>
                                    <option value="trueskill">TrueSkill</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="itemsInput" class="form-label">Items to Compare:</label>
                                <div class="card bg-dark p-3">
                                    <div id="itemsContainer" class="mb-3">
                                        <div class="item-entry d-flex align-items-center mb-2">
                                            <span class="drag-handle material-icons me-2">drag_handle</span>
                                            <input type="text" class="form-control" placeholder="Item name">
                                            <button type="button" class="btn btn-sm btn-danger ms-2 remove-item">
                                                <span class="material-icons">remove</span>
                                            </button>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-secondary" id="addItemBtn">
                                        <span class="material-icons me-1">add</span>Add Item
                                    </button>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="form-label">Or import items:</label>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-secondary" id="pasteBtn" type="button">
                                        <span class="material-icons me-1">content_paste</span>Paste from Clipboard
                                    </button>
                                    <button class="btn btn-outline-secondary" id="importBtn" type="button">
                                        <span class="material-icons me-1">file_upload</span>Import from File
                                    </button>
                                    <input type="file" id="fileInput" class="d-none" accept=".txt,.csv,.json">
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-task d-flex align-items-center" id="startBtn" type="button">
                                    <span class="material-icons me-1">play_arrow</span>Start Comparing
                                </button>
                                <button class="btn btn-edit d-flex align-items-center" id="loadSessionBtn" type="button">
                                    <span class="material-icons me-1">history</span>Load Previous Session
                                </button>
                            </div>
                        </div>
                        <div id="compareStage" class="d-none">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2 class="h5 mb-0" id="roundInfo">Round 1 - Winners Bracket</h2>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-secondary" id="viewBracketBtn" type="button">
                                        <span class="material-icons me-1">table_chart</span>View Bracket
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" id="pauseBtn" type="button">
                                        <span class="material-icons me-1">pause</span>Pause
                                    </button>
                                </div>
                            </div>
                            <div class="progress mb-4">
                                <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="mb-3 text-center">
                                <span class="badge bg-secondary">Comparison <span id="currentComparison">1</span> of <span id="totalComparisons">10</span></span>
                            </div>
                            <div class="row g-4 mb-4">
                                <div class="col-md-6">
                                    <div class="comparison-item card h-100" id="item1">
                                        <div class="card-body text-center">
                                            <h3 class="h4" id="item1Name">Item 1</h3>
                                            <div class="mt-3" id="item1Stats">
                                                <small class="text-muted">Elo: 1200 | Wins: 0</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="comparison-item card h-100" id="item2">
                                        <div class="card-body text-center">
                                            <h3 class="h4" id="item2Name">Item 2</h3>
                                            <div class="mt-3" id="item2Stats">
                                                <small class="text-muted">Elo: 1200 | Wins: 0</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mb-4">
                                <p class="text-muted">Select the better item or</p>
                            </div>
                            <div class="d-flex justify-content-center gap-3 flex-wrap">
                                <button class="btn btn-primary btn-lg px-4" id="selectItem1" type="button">
                                    <span class="material-icons me-1">check</span>Choose Left
                                </button>
                                <button class="btn btn-secondary btn-lg px-4" id="tieBtn" type="button">
                                    <span class="material-icons me-1">balance</span>It's a Tie
                                </button>
                                <button class="btn btn-primary btn-lg px-4" id="selectItem2" type="button">
                                    <span class="material-icons me-1">check</span>Choose Right
                                </button>
                            </div>
                        </div>
                        <div id="resultsStage" class="d-none">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2 class="h4 mb-0">Tournament Results</h2>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-secondary" id="shareBtn" type="button">
                                        <span class="material-icons me-1">share</span>Share Results
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" id="exportBtn" type="button">
                                        <span class="material-icons me-1">download</span>Export
                                    </button>
                                </div>
                            </div>
                            <div class="tournament-bracket mb-4" id="bracketVisualization"></div>
                            <div class="table-responsive">
                                <table class="table table-dark table-hover">
                                    <thead>
                                        <tr>
                                            <th>Rank</th>
                                            <th>Item</th>
                                            <th>Rating</th>
                                            <th>Wins</th>
                                            <th>Losses</th>
                                            <th>Win %</th>
                                        </tr>
                                    </thead>
                                    <tbody id="resultsTable"></tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-center gap-3 mt-4">
                                <button class="btn btn-task d-flex align-items-center" id="newTournamentBtn" type="button">
                                    <span class="material-icons me-1">add</span>New Tournament
                                </button>
                                <button class="btn btn-edit d-flex align-items-center" id="saveResultsBtn" type="button">
                                    <span class="material-icons me-1">save</span>Save Results
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card p-4 mt-4">
                    <h3 class="h5 mb-3">How to Use This Tool</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex mb-3">
                                <span class="material-icons me-3 text-primary">add_circle</span>
                                <div>
                                    <h4 class="h6">Add Items</h4>
                                    <p class="small text-muted mb-0">Add items manually or import from a file</p>
                                </div>
                            </div>
                            <div class="d-flex mb-3">
                                <span class="material-icons me-3 text-primary">compare_arrows</span>
                                <div>
                                    <h4 class="h6">Compare</h4>
                                    <p class="small text-muted mb-0">Select which item is better in each pairing</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex mb-3">
                                <span class="material-icons me-3 text-primary">auto_graph</span>
                                <div>
                                    <h4 class="h6">Track Progress</h4>
                                    <p class="small text-muted mb-0">Watch the ranking evolve in real-time</p>
                                </div>
                            </div>
                            <div class="d-flex mb-3">
                                <span class="material-icons me-3 text-primary">emoji_events</span>
                                <div>
                                    <h4 class="h6">View Results</h4>
                                    <p class="small text-muted mb-0">See final rankings and export your results</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <aside class="col-md-3">
                <div class="card bg-dark border-secondary">
                    <div class="card-body p-0">
                        <div id="dynamic-sidebar" class="sidebar"></div>
                    </div>
                </div>
            </aside>
        </div>
    </div>
    <div id="footer-placeholder"></div>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/component-loader.js"></script>
    <script src="js/main.js"></script>
    <!-- The main Compare Items JS logic would go here. For brevity, only the UI skeleton and event hooks are included. -->
    <script>
    // Load header, footer, and sidebar dynamically
    ComponentLoader.loadHeader();
    ComponentLoader.loadFooter();
    if (typeof loadSidebar === 'function') loadSidebar();

    // --- File import logic ---
    document.addEventListener('DOMContentLoaded', function() {
        // DOM refs
        const importBtn = document.getElementById('importBtn');
        const fileInput = document.getElementById('fileInput');
        const itemsContainer = document.getElementById('itemsContainer');
        const addItemBtn = document.getElementById('addItemBtn');
        const pasteBtn = document.getElementById('pasteBtn');
        const startBtn = document.getElementById('startBtn');
        const loadSessionBtn = document.getElementById('loadSessionBtn');
        const selectItem1 = document.getElementById('selectItem1');
        const selectItem2 = document.getElementById('selectItem2');
        const tieBtn = document.getElementById('tieBtn');
        const newTournamentBtn = document.getElementById('newTournamentBtn');
        const saveResultsBtn = document.getElementById('saveResultsBtn');
        const setupStage = document.getElementById('setupStage');
        const compareStage = document.getElementById('compareStage');
        const resultsStage = document.getElementById('resultsStage');
        const item1Name = document.getElementById('item1Name');
        const item2Name = document.getElementById('item2Name');
        const progressBar = document.getElementById('progressBar');
        const currentComparison = document.getElementById('currentComparison');
        const totalComparisons = document.getElementById('totalComparisons');
        const resultsTable = document.getElementById('resultsTable');

        // State
        let items = [];
        let pairs = [];
        let pairIndex = 0;
        let results = [];

        // Add item row
        function addItemEntry(val = '') {
            const itemEntry = document.createElement('div');
            itemEntry.className = 'item-entry d-flex align-items-center mb-2';
            itemEntry.innerHTML = `
                <span class="drag-handle material-icons me-2">drag_handle</span>
                <input type="text" class="form-control" placeholder="Item name" value="${val.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}">
                <button type="button" class="btn btn-sm btn-danger ms-2 remove-item"><span class="material-icons">remove</span></button>
            `;
            itemEntry.querySelector('.remove-item').addEventListener('click', function() {
                itemEntry.remove();
            });
            itemsContainer.appendChild(itemEntry);
        }

        // Add item button
        if (addItemBtn) addItemBtn.addEventListener('click', () => addItemEntry(''));

        // Paste from clipboard
        if (pasteBtn) pasteBtn.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
                lines.forEach(line => addItemEntry(line));
            } catch (e) { alert('Paste failed.'); }
        });

        // Import from file
        if (importBtn && fileInput && itemsContainer) {
            importBtn.addEventListener('click', function() {
                fileInput.value = '';
                fileInput.click();
            });
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    let lines = [];
                    try {
                        if (file.name.endsWith('.json')) {
                            const arr = JSON.parse(evt.target.result);
                            if (Array.isArray(arr)) lines = arr.map(String);
                        } else {
                            lines = evt.target.result.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
                        }
                    } catch (err) {
                        alert('Could not parse file.');
                        return;
                    }
                    itemsContainer.innerHTML = '';
                    lines.forEach(line => addItemEntry(line));
                };
                reader.readAsText(file);
            });
        }

        // Start comparing
        if (startBtn) startBtn.addEventListener('click', () => {
            // Gather items
            items = Array.from(itemsContainer.querySelectorAll('input')).map(i => i.value.trim()).filter(Boolean);
            if (items.length < 2) { alert('Enter at least two items.'); return; }
            // Generate all pairs (simple round robin for demo)
            pairs = [];
            for (let i = 0; i < items.length; i++) {
                for (let j = i + 1; j < items.length; j++) {
                    pairs.push([items[i], items[j]]);
                }
            }
            pairIndex = 0;
            results = items.map(name => ({ name, wins: 0, losses: 0 }));
            setupStage.classList.add('d-none');
            compareStage.classList.remove('d-none');
            resultsStage.classList.add('d-none');
            updateCompareUI();
        });

        // Update compare UI
        function updateCompareUI() {
            if (pairIndex >= pairs.length) {
                showResults();
                return;
            }
            const [a, b] = pairs[pairIndex];
            item1Name.textContent = a;
            item2Name.textContent = b;
            currentComparison.textContent = pairIndex + 1;
            totalComparisons.textContent = pairs.length;
            progressBar.style.width = ((pairIndex + 1) / pairs.length * 100) + '%';
        }

        // Handle selection
        function handleSelection(winnerIdx) {
            const [a, b] = pairs[pairIndex];
            if (winnerIdx === 0) {
                results.find(r => r.name === a).wins++;
                results.find(r => r.name === b).losses++;
            } else if (winnerIdx === 1) {
                results.find(r => r.name === b).wins++;
                results.find(r => r.name === a).losses++;
            }
            pairIndex++;
            updateCompareUI();
        }
        if (selectItem1) selectItem1.addEventListener('click', () => handleSelection(0));
        if (selectItem2) selectItem2.addEventListener('click', () => handleSelection(1));
        if (tieBtn) tieBtn.addEventListener('click', () => { pairIndex++; updateCompareUI(); });

        // Show results
        function showResults() {
            compareStage.classList.add('d-none');
            resultsStage.classList.remove('d-none');
            // Sort by wins desc
            const sorted = [...results].sort((a, b) => b.wins - a.wins);
            resultsTable.innerHTML = '';
            sorted.forEach((r, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${i + 1}</td><td>${r.name}</td><td>-</td><td>${r.wins}</td><td>${r.losses}</td><td>${((r.wins/(r.wins+r.losses||1))*100).toFixed(1)}%</td>`;
                resultsTable.appendChild(tr);
            });
        }

        // New tournament
        if (newTournamentBtn) newTournamentBtn.addEventListener('click', () => {
            setupStage.classList.remove('d-none');
            compareStage.classList.add('d-none');
            resultsStage.classList.add('d-none');
            itemsContainer.innerHTML = '';
            addItemEntry('');
        });

        // Save results (CSV)
        if (saveResultsBtn) saveResultsBtn.addEventListener('click', () => {
            let csv = 'Rank,Item,Wins,Losses,Win%\n';
            const sorted = [...results].sort((a, b) => b.wins - a.wins);
            sorted.forEach((r, i) => {
                csv += `${i + 1},"${r.name.replace(/"/g,'""')}",${r.wins},${r.losses},${((r.wins/(r.wins+r.losses||1))*100).toFixed(1)}%\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'compare-items-results.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    });
    </script>
</body>
</html>
