<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hashing Tool - Text Utilities</title>
    <script>
        (function () {
            try {
                const storedTheme = localStorage.getItem('theme');
                const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
                const resolvedTheme = storedTheme === 'light' || storedTheme === 'dark'
                    ? storedTheme
                    : (prefersLight ? 'light' : 'dark');
                document.documentElement.setAttribute('data-theme', resolvedTheme);

                const storedAccent = localStorage.getItem('accentColor');
                let normalizedAccent = typeof storedAccent === 'string' ? storedAccent.trim().toLowerCase() : '';
                if (/^#[0-9a-f]{3}$/.test(normalizedAccent)) {
                    normalizedAccent = `#${normalizedAccent[1]}${normalizedAccent[1]}${normalizedAccent[2]}${normalizedAccent[2]}${normalizedAccent[3]}${normalizedAccent[3]}`;
                }

                if (/^#[0-9a-f]{6}$/.test(normalizedAccent)) {
                    const red = parseInt(normalizedAccent.slice(1, 3), 16);
                    const green = parseInt(normalizedAccent.slice(3, 5), 16);
                    const blue = parseInt(normalizedAccent.slice(5, 7), 16);
                    document.documentElement.style.setProperty('--accent', normalizedAccent);
                    document.documentElement.style.setProperty('--accent-rgb', `${red}, ${green}, ${blue}`);
                }
            } catch (_) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <a href="index.html" style="color: inherit; text-decoration: none;">
                    <span>Text Utilities</span>
                </a>
            </div>
            <nav class="site-network" aria-label="Network sites">
                <a href="https://chessnerd.net" class="site-network-link" target="_blank" rel="noopener noreferrer">
                    <img src="img/chessnerd-icon.png" class="site-network-icon" alt="">
                    <span>Chess Nerd</span>
                    <span class="material-icons" aria-hidden="true">open_in_new</span>
                </a>
                <a href="https://github.com/ianrastall/text-utils" class="site-network-link" target="_blank" rel="noopener noreferrer">
                    <img src="img/github.png" class="site-network-icon" alt="">
                    <span>GitHub</span>
                    <span class="material-icons" aria-hidden="true">open_in_new</span>
                </a>
            </nav>
            <div class="controls">
                <div class="accent-selector">
                    <span class="material-icons">palette</span>
                    <select id="accentColor" class="color-dropdown" aria-label="Accent color"></select>
                </div>
                <button id="themeToggle" class="btn btn-secondary" type="button" aria-label="Toggle theme" aria-pressed="false">
                    <span class="material-icons">dark_mode</span>
                </button>
            </div>
        </header>

                <main>
            <div class="tool-container">
                <div class="tool-header">
                    <div class="tool-title">
                        <span class="material-icons">lock</span>
                        <h2>Hashing Tool</h2>
                    </div>
                    <div class="tool-actions">
                        <button id="backButton" class="btn btn-secondary btn-compact">
                            <span class="material-icons">arrow_back</span>
                            Back
                        </button>
                        <button id="copyOutput" class="btn btn-secondary btn-compact">
                            <span class="material-icons">content_copy</span>
                            Copy
                        </button>
                        <button id="transformBtn" class="btn btn-primary">
                            <span class="material-icons">sync_alt</span>
                            Transform
                        </button>
                    </div>
                </div>

                <p class="tool-description">Hash, encode, and decode text using various algorithms and formats</p>

                <div class="options-panel">
                    <div class="options-grid">
                        <div class="option-group">
                            <label for="operationType">Operation</label>
                            <select id="operationType" class="form-select">
                                <option value="encode">Encode / Hash</option>
                                <option value="decode">Decode</option>
                            </select>
                        </div>
                        <div class="option-group">
                            <label for="algorithmSelect">Algorithm</label>
                            <select id="algorithmSelect" class="form-select">
                                <optgroup label="Common Encodings">
                                    <option value="base64">Base64</option>
                                    <option value="base64url">Base64-URL</option>
                                    <option value="base32">Base32</option>
                                    <option value="url">URL Encoding</option>
                                    <option value="hex">Hexadecimal</option>
                                    <option value="html">HTML Entities</option>
                                </optgroup>
                                <optgroup label="Hashing (Encode Only)">
                                    <option value="md5">MD5</option>
                                    <option value="sha1">SHA-1</option>
                                    <option value="sha256">SHA-256</option>
                                    <option value="sha384">SHA-384</option>
                                    <option value="sha512">SHA-512</option>
                                    <option value="crc32">CRC-32</option>
                                </optgroup>
                                <optgroup label="Other">
                                    <option value="rot13">ROT13</option>
                                    <option value="rot47">ROT47</option>
                                    <option value="binary">Binary</option>
                                    <option value="reverse">Reverse Text</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="io-container">
                    <div class="io-panel">
                        <div class="io-label">
                            <span>Input</span>
                            <span class="stats pill muted" id="inputStats">0 chars</span>
                        </div>
                        <textarea id="textInput" placeholder="Enter text here..."></textarea>
                    </div>
                    <div class="io-panel">
                        <div class="io-label">
                            <span>Output</span>
                            <span class="stats pill muted" id="outputStats">0 chars</span>
                        </div>
                        <textarea id="textOutput" class="output" readonly placeholder="Results will appear here..."></textarea>
                    </div>
                </div>

                <div class="status-bar">
                    <div id="statusMessage" class="success">Ready</div>
                    <div id="processingTime">No operations yet</div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/theme.js"></script>
    <script>
        'use strict';

        const textArea = document.getElementById('textInput');
        const outputArea = document.getElementById('textOutput');
        const operationType = document.getElementById('operationType');
        const algorithmSelect = document.getElementById('algorithmSelect');
        const transformBtn = document.getElementById('transformBtn');
        const copyBtn = document.getElementById('copyOutput');
        const backBtn = document.getElementById('backButton');
        const statusMessage = document.getElementById('statusMessage');
        const processingTime = document.getElementById('processingTime');
        const inputStats = document.getElementById('inputStats');
        const outputStats = document.getElementById('outputStats');
        
        const HASH_ALGORITHMS = ['md5', 'sha1', 'sha256', 'sha384', 'sha512', 'crc32'];

        // --- Modern, UTF-8 Safe Base64/Base64-URL ---
        const encodeBase64 = (text, isUrlSafe = false) => {
            const bytes = new TextEncoder().encode(text);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            let base64 = btoa(binary);
            if (isUrlSafe) {
                base64 = base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
            }
            return base64;
        };

        const decodeBase64 = (text, isUrlSafe = false) => {
            if (isUrlSafe) {
                text = text.replace(/-/g, '+').replace(/_/g, '/');
                while (text.length % 4) text += '=';
            }
            const binaryString = atob(text);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return new TextDecoder().decode(bytes);
        };

        // --- Base32 Implementation ---
        const base32Alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
        
        const encodeBase32 = (text) => {
            const bytes = new TextEncoder().encode(text);
            let result = '';
            let buffer = 0;
            let bitsLeft = 0;
            
            for (let i = 0; i < bytes.length; i++) {
                buffer = (buffer << 8) | bytes[i];
                bitsLeft += 8;
                
                while (bitsLeft >= 5) {
                    result += base32Alphabet[(buffer >> (bitsLeft - 5)) & 31];
                    bitsLeft -= 5;
                }
            }
            
            if (bitsLeft > 0) {
                result += base32Alphabet[(buffer << (5 - bitsLeft)) & 31];
            }
            
            while (result.length % 8 !== 0) {
                result += '=';
            }
            
            return result;
        };

        const decodeBase32 = (text) => {
            text = text.replace(/=+$/, '').toUpperCase();
            const bytes = [];
            let buffer = 0;
            let bitsLeft = 0;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const value = base32Alphabet.indexOf(char);
                if (value === -1) throw new Error('Invalid Base32 character: ' + char);
                
                buffer = (buffer << 5) | value;
                bitsLeft += 5;
                
                if (bitsLeft >= 8) {
                    bytes.push((buffer >> (bitsLeft - 8)) & 255);
                    bitsLeft -= 8;
                }
            }
            
            return new TextDecoder().decode(new Uint8Array(bytes));
        };

        // --- Other Helpers ---
        const rot47 = (str) => str.replace(/[\x21-\x7E]/g, c => String.fromCharCode(33 + ((c.charCodeAt(0) + 14) % 94)));

        // --- MD5 Implementation ---
        const md5 = (str) => {
            const md5cycle = (x, k) => {
                let a = x[0], b = x[1], c = x[2], d = x[3];
                
                const cmn = (q, a, b, x, s, t) => {
                    a = add32(add32(a, q), add32(x, t));
                    return add32((a << s) | (a >>> (32 - s)), b);
                };
                const ff = (a, b, c, d, x, s, t) => cmn((b & c) | ((~b) & d), a, b, x, s, t);
                const gg = (a, b, c, d, x, s, t) => cmn((b & d) | (c & (~d)), a, b, x, s, t);
                const hh = (a, b, c, d, x, s, t) => cmn(b ^ c ^ d, a, b, x, s, t);
                const ii = (a, b, c, d, x, s, t) => cmn(c ^ (b | (~d)), a, b, x, s, t);
                
                a = ff(a, b, c, d, k[0], 7, -680876936);
                d = ff(d, a, b, c, k[1], 12, -389564586);
                c = ff(c, d, a, b, k[2], 17, 606105819);
                b = ff(b, c, d, a, k[3], 22, -1044525330);
                a = ff(a, b, c, d, k[4], 7, -176418897);
                d = ff(d, a, b, c, k[5], 12, 1200080426);
                c = ff(c, d, a, b, k[6], 17, -1473231341);
                b = ff(b, c, d, a, k[7], 22, -45705983);
                a = ff(a, b, c, d, k[8], 7, 1770035416);
                d = ff(d, a, b, c, k[9], 12, -1958414417);
                c = ff(c, d, a, b, k[10], 17, -42063);
                b = ff(b, c, d, a, k[11], 22, -1990404162);
                a = ff(a, b, c, d, k[12], 7, 1804603682);
                d = ff(d, a, b, c, k[13], 12, -40341101);
                c = ff(c, d, a, b, k[14], 17, -1502002290);
                b = ff(b, c, d, a, k[15], 22, 1236535329);
                
                a = gg(a, b, c, d, k[1], 5, -165796510);
                d = gg(d, a, b, c, k[6], 9, -1069501632);
                c = gg(c, d, a, b, k[11], 14, 643717713);
                b = gg(b, c, d, a, k[0], 20, -373897302);
                a = gg(a, b, c, d, k[5], 5, -701558691);
                d = gg(d, a, b, c, k[10], 9, 38016083);
                c = gg(c, d, a, b, k[15], 14, -660478335);
                b = gg(b, c, d, a, k[4], 20, -405537848);
                a = gg(a, b, c, d, k[9], 5, 568446438);
                d = gg(d, a, b, c, k[14], 9, -1019803690);
                c = gg(c, d, a, b, k[3], 14, -187363961);
                b = gg(b, c, d, a, k[8], 20, 1163531501);
                a = gg(a, b, c, d, k[13], 5, -1444681467);
                d = gg(d, a, b, c, k[2], 9, -51403784);
                c = gg(c, d, a, b, k[7], 14, 1735328473);
                b = gg(b, c, d, a, k[12], 20, -1926607734);
                
                a = hh(a, b, c, d, k[5], 4, -378558);
                d = hh(d, a, b, c, k[8], 11, -2022574463);
                c = hh(c, d, a, b, k[11], 16, 1839030562);
                b = hh(b, c, d, a, k[14], 23, -35309556);
                a = hh(a, b, c, d, k[1], 4, -1530992060);
                d = hh(d, a, b, c, k[4], 11, 1272893353);
                c = hh(c, d, a, b, k[7], 16, -155497632);
                b = hh(b, c, d, a, k[10], 23, -1094730640);
                a = hh(a, b, c, d, k[13], 4, 681279174);
                d = hh(d, a, b, c, k[0], 11, -358537222);
                c = hh(c, d, a, b, k[3], 16, -722521979);
                b = hh(b, c, d, a, k[6], 23, 76029189);
                a = hh(a, b, c, d, k[9], 4, -640364487);
                d = hh(d, a, b, c, k[12], 11, -421815835);
                c = hh(c, d, a, b, k[15], 16, 530742520);
                b = hh(b, c, d, a, k[2], 23, -995338651);
                
                a = ii(a, b, c, d, k[0], 6, -198630844);
                d = ii(d, a, b, c, k[7], 10, 1126891415);
                c = ii(c, d, a, b, k[14], 15, -1416354905);
                b = ii(b, c, d, a, k[5], 21, -57434055);
                a = ii(a, b, c, d, k[12], 6, 1700485571);
                d = ii(d, a, b, c, k[3], 10, -1894986606);
                c = ii(c, d, a, b, k[10], 15, -1051523);
                b = ii(b, c, d, a, k[1], 21, -2054922799);
                a = ii(a, b, c, d, k[8], 6, 1873313359);
                d = ii(d, a, b, c, k[15], 10, -30611744);
                c = ii(c, d, a, b, k[6], 15, -1560198380);
                b = ii(b, c, d, a, k[13], 21, 1309151649);
                a = ii(a, b, c, d, k[4], 6, -145523070);
                d = ii(d, a, b, c, k[11], 10, -1120210379);
                c = ii(c, d, a, b, k[2], 15, 718787259);
                b = ii(b, c, d, a, k[9], 21, -343485551);
                
                x[0] = add32(a, x[0]);
                x[1] = add32(b, x[1]);
                x[2] = add32(c, x[2]);
                x[3] = add32(d, x[3]);
            };
            
            const md51 = (s) => {
                const n = s.length;
                const state = [1732584193, -271733879, -1732584194, 271733878];
                let i;
                for (i = 64; i <= s.length; i += 64) {
                    md5cycle(state, md5blk(s.substring(i - 64, i)));
                }
                s = s.substring(i - 64);
                const tail = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                for (i = 0; i < s.length; i++)
                    tail[i >> 2] |= s.charCodeAt(i) << ((i % 4) << 3);
                tail[i >> 2] |= 0x80 << ((i % 4) << 3);
                if (i > 55) {
                    md5cycle(state, tail);
                    for (i = 0; i < 16; i++) tail[i] = 0;
                }
                tail[14] = n * 8;
                md5cycle(state, tail);
                return state;
            };
            
            const md5blk = (s) => {
                const md5blks = [];
                for (let i = 0; i < 64; i += 4) {
                    md5blks[i >> 2] = s.charCodeAt(i) + (s.charCodeAt(i + 1) << 8) + (s.charCodeAt(i + 2) << 16) + (s.charCodeAt(i + 3) << 24);
                }
                return md5blks;
            };
            
            const rhex = (n) => {
                let s = '';
                const hex_chr = '0123456789abcdef'.split('');
                for (let j = 0; j < 4; j++)
                    s += hex_chr[(n >> (j * 8 + 4)) & 0x0F] + hex_chr[(n >> (j * 8)) & 0x0F];
                return s;
            };
            
            const add32 = (a, b) => (a + b) & 0xFFFFFFFF;
            
            const utf8Encode = (str) => {
                let utf8 = '';
                for (let i = 0; i < str.length; i++) {
                    let charcode = str.charCodeAt(i);
                    if (charcode < 0x80) utf8 += String.fromCharCode(charcode);
                    else if (charcode < 0x800) {
                        utf8 += String.fromCharCode(0xc0 | (charcode >> 6));
                        utf8 += String.fromCharCode(0x80 | (charcode & 0x3f));
                    }
                    else if (charcode < 0xd800 || charcode >= 0xe000) {
                        utf8 += String.fromCharCode(0xe0 | (charcode >> 12));
                        utf8 += String.fromCharCode(0x80 | ((charcode >> 6) & 0x3f));
                        utf8 += String.fromCharCode(0x80 | (charcode & 0x3f));
                    }
                    else {
                        i++;
                        charcode = 0x10000 + (((charcode & 0x3ff) << 10) | (str.charCodeAt(i) & 0x3ff));
                        utf8 += String.fromCharCode(0xf0 | (charcode >> 18));
                        utf8 += String.fromCharCode(0x80 | ((charcode >> 12) & 0x3f));
                        utf8 += String.fromCharCode(0x80 | ((charcode >> 6) & 0x3f));
                        utf8 += String.fromCharCode(0x80 | (charcode & 0x3f));
                    }
                }
                return utf8;
            };
            
            return md51(utf8Encode(str)).map(rhex).join('');
        };

        // --- CRC32 Implementation ---
        const crc32 = (str) => {
            const table = [];
            let c;
            for (let n = 0; n < 256; n++) {
                c = n;
                for (let k = 0; k < 8; k++) {
                    c = ((c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1));
                }
                table[n] = c;
            }
            
            let crc = 0 ^ (-1);
            const bytes = new TextEncoder().encode(str);
            for (let i = 0; i < bytes.length; i++) {
                crc = (crc >>> 8) ^ table[(crc ^ bytes[i]) & 0xFF];
            }
            return ((crc ^ (-1)) >>> 0).toString(16).padStart(8, '0');
        };

        // --- Transformation Engine ---
        const transformText = async () => {
            const text = textArea.value;
            if (!text) {
                showStatus('Please enter some text to transform.', 'warning');
                return;
            }

            const operation = operationType.value;
            const algorithm = algorithmSelect.value;

            try {
                let result = '';
                const isEncode = operation === 'encode';

                if (!isEncode && HASH_ALGORITHMS.includes(algorithm)) {
                    showStatus('Hashing algorithms cannot be decoded.', 'warning');
                    return;
                }

                const startTime = performance.now();

                if (isEncode) {
                    switch (algorithm) {
                        case 'base64': result = encodeBase64(text); break;
                        case 'base64url': result = encodeBase64(text, true); break;
                        case 'base32': result = encodeBase32(text); break;
                        case 'url': result = encodeURIComponent(text); break;
                        case 'hex': result = [...new TextEncoder().encode(text)].map(b => b.toString(16).padStart(2, '0')).join(''); break;
                        case 'html': result = text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); break;
                        case 'rot13': result = text.replace(/[a-zA-Z]/g, c => String.fromCharCode((c <= 'Z' ? 90 : 122) >= (c = c.charCodeAt(0) + 13) ? c : c - 26)); break;
                        case 'rot47': result = rot47(text); break;
                        case 'binary': result = [...new TextEncoder().encode(text)].map(b => b.toString(2).padStart(8, '0')).join(' '); break;
                        case 'reverse': result = [...text].reverse().join(''); break;
                        default: result = await hashText(text, algorithm); break;
                    }
                } else {
                    switch (algorithm) {
                        case 'base64': result = decodeBase64(text); break;
                        case 'base64url': result = decodeBase64(text, true); break;
                        case 'base32': result = decodeBase32(text); break;
                        case 'url': result = decodeURIComponent(text); break;
                        case 'hex':
                            const hex = text.replace(/[^0-9a-fA-F]/g, '');
                            if (hex.length % 2 !== 0) throw new Error('Invalid hex string length');
                            const bytes = new Uint8Array(hex.match(/../g).map(h => parseInt(h, 16)));
                            result = new TextDecoder().decode(bytes);
                            break;
                        case 'html':
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(text, 'text/html');
                            result = doc.documentElement.textContent;
                            break;
                        case 'rot13': result = text.replace(/[a-zA-Z]/g, c => String.fromCharCode((c <= 'Z' ? 90 : 122) >= (c = c.charCodeAt(0) + 13) ? c : c - 26)); break;
                        case 'rot47': result = rot47(text); break;
                        case 'binary':
                            const binaryCleaned = text.replace(/\s+/g, '');
                            if (/[^01]/.test(binaryCleaned) || binaryCleaned.length % 8 !== 0) throw new Error('Invalid binary string');
                            const binaryBytes = new Uint8Array(binaryCleaned.match(/.{1,8}/g).map(bin => parseInt(bin, 2)));
                            result = new TextDecoder().decode(binaryBytes);
                            break;
                        case 'reverse': result = [...text].reverse().join(''); break;
                        default: throw new Error(`Decoding not supported for ${algorithm}`);
                    }
                }

                const endTime = performance.now();
                outputArea.value = result;
                showStatus(`Success: ${operation}d with ${algorithm}.`, 'success');
                processingTime.textContent = `Processed in ${Math.round(endTime - startTime)}ms`;
                updateStats();
            } catch (error) {
                console.error('Transformation error:', error);
                showStatus(`Error during ${operation}: ${error.message}`, 'error');
                processingTime.textContent = 'Processing failed';
            }
        };

        // --- Hashing Logic ---
        async function hashText(text, algorithm) {
            const algoUpper = algorithm.toUpperCase();
            if (algoUpper === 'MD5') return md5(text);
            if (algoUpper === 'CRC32') return crc32(text);

            const algoMap = {'SHA1':'SHA-1', 'SHA256':'SHA-256', 'SHA384':'SHA-384', 'SHA512':'SHA-512'};
            if (!algoMap[algoUpper]) throw new Error('Unsupported hash algorithm');

            const data = new TextEncoder().encode(text);
            const hashBuffer = await crypto.subtle.digest(algoMap[algoUpper], data);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // --- Status & Stats ---
        function showStatus(message, type = 'success') {
            statusMessage.textContent = message;
            statusMessage.className = type;
        }

        function updateStats() {
            const input = textArea.value;
            const output = outputArea.value;
            inputStats.textContent = `${input.length} chars, ${input.split('\n').length} lines`;
            outputStats.textContent = `${output.length} chars, ${output.split('\n').length} lines`;
        }

        // --- Event Listeners ---
        transformBtn.addEventListener('click', transformText);
        textArea.addEventListener('keydown', e => {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                transformText();
            }
        });

        copyBtn.addEventListener('click', () => {
            if (!outputArea.value) {
                showStatus('Nothing to copy.', 'warning');
                return;
            }
            navigator.clipboard.writeText(outputArea.value).then(
                () => showStatus('Result copied to clipboard!', 'success'),
                () => showStatus('Copy failed.', 'error')
            );
        });

        backBtn.addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        textArea.addEventListener('input', updateStats);

        const safeguardOperation = () => {
            if (HASH_ALGORITHMS.includes(algorithmSelect.value) && operationType.value === 'decode') {
                operationType.value = 'encode';
                showStatus('Hashing algorithms only support encoding.', 'warning');
            }
        };

        algorithmSelect.addEventListener('change', safeguardOperation);
        operationType.addEventListener('change', safeguardOperation);

        // Initialize
        updateStats();
    </script>
    <footer class="site-footer">
        <p>&copy; Ian Rastall 2025<br>Contact: moving.form.of.dust@gmail.com<br>Donate: PayPal to merastall@gmail.com</p>
    </footer>
</body>
</html>
