<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find & Replace - Text Utils</title>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="css/bootstrap.min.css" onerror="this.onerror=null;this.href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css'">
    <link rel="stylesheet" href="css/custom.css" onerror="this.onerror=null;this.href='https://cdn.jsdelivr.net/gh/ianrastall/text-utils@main/css/custom.css'">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        /* Local styles for the line-numbered textarea component */
        .line-numbered-container {
            display: flex;
            background-color: #212529; /* Match Bootstrap's dark form control */
            font-family: monospace;
            font-size: 1em;
            line-height: 1.5;
            overflow: hidden; /* Ensures the border-radius is applied to children */
        }
        .line-numbers-gutter {
            flex-shrink: 0;
            padding: .375rem .75rem;
            color: #6c757d; /* Muted gray for numbers */
            text-align: right;
            user-select: none;
            overflow-y: hidden; /* Gutter scroll is handled by JS */
            margin: 0;
        }
        .line-numbered-container textarea.form-control {
            flex-grow: 1;
            border: none !important;
            box-shadow: none !important;
            resize: vertical;
            padding-left: .5rem !important; /* Give a little space from the gutter */
            line-height: 1.5; /* Critical for alignment */
            margin: 0;
            background-color: transparent;
        }
        .line-numbered-container textarea.form-control:focus {
            border-color: transparent !important;
        }
    </style>
</head>
<body class="bg-dark text-light">

    <div id="header-placeholder"></div>

    <div class="container-fluid my-4">
        <div class="row gx-3 gy-3">
            <main class="col-md-9">
                <div class="card bg-dark border-secondary">
                    <div class="card-body">

                        <h2 class="card-title mb-4 d-flex align-items-center">
                            <span class="material-icons me-3" style="font-size: 36px;" aria-hidden="true">find_replace</span>
                            Find & Replace
                        </h2>

                        <div class="post-content">
                            <form onsubmit="return false;">
                                <div class="mb-3">
                                    <label for="inputText" class="form-label">Text to Process</label>
                                    <div class="line-numbered-container form-control p-0 h-auto">
                                        <pre id="lineNumbers" class="line-numbers-gutter">1</pre>
                                        <textarea class="form-control font-monospace"
                                                  id="inputText"
                                                  rows="10"
                                                  placeholder="Enter or paste text here..."
                                                  autofocus
                                                  wrap="off"></textarea>
                                    </div>
                                </div>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="findText" class="form-label">Find</label>
                                        <input type="text" class="form-control" id="findText" placeholder="Text or /regex/">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="replaceText" class="form-label">Replace With</label>
                                        <input type="text" class="form-control" id="replaceText" placeholder="Replacement text (use $1 or \1)">
                                    </div>
                                </div>
                                <small class="form-text text-white-50 d-block mt-2 mb-3">
                                    <strong>Tip:</strong> In plain text mode, different newline types (e.g., Windows `\r\n`) are matched as a single `\n` character. Use `\n` in the "Replace With" field to insert a line break.
                                </small>


                                <div class="mb-3 d-flex flex-wrap gap-3 align-items-center">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="caseSensitive" title="Toggle case sensitivity">
                                        <label class="form-check-label" for="caseSensitive">Case Sensitive</label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="useRegex">
                                        <label class="form-check-label" for="useRegex">Use Regular Expression</label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="multilineMode" checked>
                                        <label class="form-check-label" for="multilineMode">Multiline (^, $)</label>
                                    </div>
                                </div>

                                <div class="d-flex gap-2 flex-wrap mb-3">
                                    <button type="button" class="btn btn-task d-flex align-items-center" id="replaceAllBtn">
                                        <span class="material-icons me-2" aria-hidden="true">find_replace</span>Replace All
                                    </button>
                                    <button type="button" class="btn btn-edit d-flex align-items-center" id="revertBtn" disabled>
                                         <span class="material-icons me-2" aria-hidden="true">undo</span>Revert
                                    </button>
                                    <button type="button" class="btn btn-edit d-flex align-items-center" id="pasteBtn">
                                         <span class="material-icons me-2" aria-hidden="true">content_paste</span>Paste
                                    </button>
                                    <button type="button" class="btn btn-edit d-flex align-items-center" id="copyBtn">
                                         <span class="material-icons me-2" aria-hidden="true">content_copy</span>Copy Result
                                    </button>
                                    <button type="button" class="btn btn-clear d-flex align-items-center" id="clearBtn">
                                         <span class="material-icons me-2" aria-hidden="true">clear</span>Clear All
                                    </button>
                                </div>

                                <div id="matchCount" class="text-muted" style="min-height: 1.5em;" aria-live="polite" aria-atomic="true"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </main>

            <aside class="col-md-3">
                <div id="sidebar-placeholder">
                    <div class="card bg-dark border-secondary">
                        <div class="card-body">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <script src="js/bootstrap.bundle.min.js" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js'"></script>
    <script src="js/component-loader.js" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/ianrastall/text-utils@main/js/component-loader.js'"></script>
    <script src="js/main.js" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/ianrastall/text-utils@main/js/main.js'"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- State ---
        let previousText = '';

        // --- Get DOM Elements ---
        const lineNumbers = document.getElementById('lineNumbers');
        const multilineModeCheckbox = document.getElementById('multilineMode');
        const textarea = document.getElementById('inputText');
        const findInput = document.getElementById('findText');
        const replaceInput = document.getElementById('replaceText');
        const caseSensitiveCheckbox = document.getElementById('caseSensitive');
        const useRegexCheckbox = document.getElementById('useRegex');
        const matchCountDisplay = document.getElementById('matchCount');
        const replaceAllBtn = document.getElementById('replaceAllBtn');
        const revertBtn = document.getElementById('revertBtn');
        const pasteBtn = document.getElementById('pasteBtn');
        const copyBtn = document.getElementById('copyBtn');
        const clearBtn = document.getElementById('clearBtn');

        if (!lineNumbers || !multilineModeCheckbox || !textarea || !findInput || !replaceInput || !caseSensitiveCheckbox || !useRegexCheckbox || !matchCountDisplay || !replaceAllBtn || !revertBtn || !pasteBtn || !copyBtn || !clearBtn) {
            console.error("Find/Replace Tool Error: One or more required UI elements not found.");
            if (matchCountDisplay) matchCountDisplay.textContent = "Error: Tool UI failed to load.";
            return;
        }
        
        // --- Helper Functions ---
        const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        };

        // --- Core Logic ---
        function updateLineNumbers() {
            requestAnimationFrame(() => {
                const lines = textarea.value.split('\n');
                const lineCount = lines.length;
                const numberText = Array.from({ length: lineCount }, (_, i) => i + 1).join('\n');
                lineNumbers.textContent = numberText;
            });
        }

        function createRegex() {
            const findValue = findInput.value;
            if (!findValue) return null;

            const isCaseSensitive = caseSensitiveCheckbox.checked;
            const useRegex = useRegexCheckbox.checked;
            const isMultiline = multilineModeCheckbox.checked;
            const flags = 'g' + (isCaseSensitive ? '' : 'i') + 'u' + (isMultiline ? 'm' : '');
            
            let pattern;
            if (useRegex) {
                pattern = findValue;
            } else {
                const normalizedFindValue = findValue.replace(/\r\n?/g, '\n');
                pattern = escapeRegExp(normalizedFindValue);
            }
            
            return new RegExp(pattern, flags);
        }
        
        function updateMatchCount() {
            try {
                const regex = createRegex();
                if (!regex) {
                    matchCountDisplay.textContent = '';
                    return;
                }
                const matches = textarea.value.match(regex);
                const count = matches ? matches.length : 0;

                if (count === 0) {
                    matchCountDisplay.textContent = 'No matches found.';
                } else {
                    matchCountDisplay.textContent = `${count} match${count > 1 ? 'es' : ''} found.`;
                }
            } catch (error) {
                if (error instanceof SyntaxError && useRegexCheckbox.checked) {
                    matchCountDisplay.textContent = 'Error: Invalid Regular Expression.';
                } else {
                    matchCountDisplay.textContent = `Error: ${error.message}`;
                }
            }
        }

        function performReplaceAll() {
            if (!findInput.value) {
                window.showGlobalToast('The "Find" field cannot be empty.', 'warning');
                findInput.focus();
                return;
            }

            try {
                const regex = createRegex();
                if (!regex) return;

                const originalText = textarea.value;
                const matches = originalText.match(regex);
                const count = matches ? matches.length : 0;

                if (count === 0) {
                    window.showGlobalToast('No matches found to replace.', 'info');
                    matchCountDisplay.textContent = 'No matches found.';
                    return;
                }
                
                previousText = originalText;
                
                const finalReplaceValue = replaceInput.value.replace(/(?<!\\)\\(\d+)/g, '$$$1');
                const resultText = originalText.replace(regex, finalReplaceValue);
                textarea.value = resultText;
                revertBtn.disabled = false;

                const message = `Replaced ${count} occurrence${count > 1 ? 's' : ''}.`;
                window.showGlobalToast(message, 'success');
                matchCountDisplay.textContent = message;
                textarea.focus();
                
                updateLineNumbers();
            } catch (error) {
                if (error instanceof SyntaxError && useRegexCheckbox.checked) {
                    window.showGlobalToast('Invalid Regular Expression', 'danger');
                    matchCountDisplay.textContent = 'Error: Invalid Regular Expression.';
                } else {
                    window.showGlobalToast('An error occurred during replacement.', 'danger');
                    matchCountDisplay.textContent = `Error: ${error.message}`;
                    console.error("Replacement Error:", error);
                }
            }
        }
        
        function revertLastChange() {
            if (previousText) {
                textarea.value = previousText;
                previousText = '';
                revertBtn.disabled = true;
                window.showGlobalToast('Last replacement has been reverted.', 'success');
                updateLineNumbers();
                updateMatchCount();
                textarea.focus();
            }
        }
        
        async function pasteText() {
            try {
                if (!navigator.clipboard?.readText) {
                    throw new Error('Clipboard paste not supported or permission denied.');
                }
                const text = await navigator.clipboard.readText();
                textarea.value = text;
                revertBtn.disabled = true;
                previousText = '';
                window.showGlobalToast('Pasted from clipboard', 'success');
                updateLineNumbers();
                updateMatchCount();
                textarea.focus();
            } catch (err) {
                window.showGlobalToast(`Paste failed: ${err.message}`, 'danger');
                console.error('Paste Error:', err);
            }
        }

        async function copyText() {
             if (!textarea.value) {
                 window.showGlobalToast('Nothing to copy', 'info');
                 return;
             }
            try {
                 if (!navigator.clipboard?.writeText) {
                     throw new Error('Clipboard copy not supported or permission denied.');
                 }
                await navigator.clipboard.writeText(textarea.value);
                window.showGlobalToast('Result copied to clipboard', 'success');
            } catch (err) {
                window.showGlobalToast(`Copy failed: ${err.message}`, 'danger');
                console.error('Copy Error:', err);
            }
        }

        function clearText() {
            textarea.value = '';
            findInput.value = '';
            replaceInput.value = '';
            caseSensitiveCheckbox.checked = false;
            useRegexCheckbox.checked = false;
            multilineModeCheckbox.checked = true;
            matchCountDisplay.textContent = '';
            revertBtn.disabled = true;
            previousText = '';
            window.showGlobalToast('Cleared all fields', 'info');
            updateLineNumbers();
            textarea.focus();
        }

        // --- Event listeners ---
        replaceAllBtn.addEventListener('click', performReplaceAll);
        revertBtn.addEventListener('click', revertLastChange);
        pasteBtn.addEventListener('click', pasteText);
        copyBtn.addEventListener('click', copyText);
        clearBtn.addEventListener('click', clearText);

        textarea.addEventListener('scroll', () => {
            lineNumbers.scrollTop = textarea.scrollTop;
        }, { passive: true });
        
        const debouncedUpdate = debounce(updateMatchCount, 250);
        
        textarea.addEventListener('input', () => {
            revertBtn.disabled = true;
            previousText = '';
            updateLineNumbers();
            debouncedUpdate();
        });

        findInput.addEventListener('input', debouncedUpdate);
        caseSensitiveCheckbox.addEventListener('change', debouncedUpdate);
        useRegexCheckbox.addEventListener('change', debouncedUpdate);
        multilineModeCheckbox.addEventListener('change', debouncedUpdate);

        const handleCtrlEnter = (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                performReplaceAll();
            }
        };
        textarea.addEventListener('keydown', handleCtrlEnter);
        findInput.addEventListener('keydown', handleCtrlEnter);
        replaceInput.addEventListener('keydown', handleCtrlEnter);
        
        updateLineNumbers();
        updateMatchCount();
    });
    </script>
</body>
</html>
