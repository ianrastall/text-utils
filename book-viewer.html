<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book Viewer</title>

  <!-- Core styles to match site look -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/bootstrap.min.css" />
  <link rel="stylesheet" href="css/custom.css" />
  <link rel="stylesheet" href="css/tutorials.css" />

  <!-- Highlight.js theme (same as Coding Tutorials) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/atom-one-dark.css" />

  <!-- Markdown-it (client-side Markdown to HTML) -->
  <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>

  <!-- Highlight.js core + common languages -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/ada.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/x86asm.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/c.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/cpp.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/csharp.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/java.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/ruby.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/es/languages/xml.min.js"></script>

  <style>
    :root { --page-pad: clamp(1rem, 4vw, 3rem); }
    html, body { width: 100%; height: 100%;
      background-color: "#212529; /* ensure dark bg across the page */ }
    body {
      padding: 5em;
      font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .content-wrap { width: 100%; }
    .markdown-body { max-width: 100%; }
    .markdown-body img { max-width: 100%; height: auto; }
    code { color: skyblue; }
    /* Optional: slightly larger headings for readability */
    .markdown-body h1 { margin-top: 0.2rem; margin-bottom: 1rem; color: powderblue; }
    .markdown-body h2 { margin-top: 0.15rem; margin-bottom: 1rem; color: cadetblue; }
    .markdown-body h3 { margin-top: 0.2rem; margin-bottom: 1rem; color: cornflowerblue; }
    .markdown-body h4 { margin-top: 0.15rem; margin-bottom: 1rem; color: dodgerblue; }
    .markdown-body pre { border-radius: .25rem; overflow: auto; }
  </style>
</head>
<body class="bg-black">
      <div class="content-wrap">
        <div id="loading" class="text-white-50 text-center p-4">
          <div class="spinner-border text-secondary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p>Loading book content...</p>
        </div>
  <article id="mainOutput" class="markdown-body tutorial-content" style="display:none;"></article>
      </div>

  <script>
    // Minimal, self-contained book renderer
    (function() {
      // Apply saved accent theme (matches site behavior without needing header)
      (function applyAccentTheme() {
        const savedTheme = localStorage.getItem('accentTheme') || 'burlywood';
        const html = document.documentElement;
        // Clear theme-* classes then add selected
        html.className = (html.className || '')
          .split(/\s+/)
          .filter(c => c && !c.startsWith('theme-'))
          .concat('theme-' + savedTheme)
          .join(' ');
      })();

      const params = new URLSearchParams(window.location.search);
      // Require explicit src; pass ?src=path/to/book.md
      const src = params.get('src');

      // Configure Markdown-it with highlight.js integration
      const md = window.markdownit({
        html: true,
        linkify: true,
        typographer: true,
        highlight: function (str, lang) {
          if (lang && hljs.getLanguage(lang)) {
            try {
              return hljs.highlight(str, { language: lang }).value;
            } catch (__) {}
          }
          return ''; // use external default escaping
        }
      });

      const output = document.getElementById('mainOutput');
      const loading = document.getElementById('loading');

      function isAbsoluteOrSpecial(url) {
        return /^([a-z][a-z0-9+.-]*:|\/|#|data:|mailto:)/i.test(url);
      }

      function baseDirOf(path) {
        const i = path.lastIndexOf('/');
        return i >= 0 ? path.slice(0, i + 1) : '';
      }

      function resolveRelativeUrls(rootEl, baseDir) {
        // Resolve against the current page URL to keep repo/subpath prefixes
        const makeAbs = (u) => new URL(u, new URL(baseDir, window.location.href)).href;
        rootEl.querySelectorAll('img[src], a[href]').forEach(el => {
          const attr = el.tagName.toLowerCase() === 'img' ? 'src' : 'href';
          const val = el.getAttribute(attr);
          if (!val || isAbsoluteOrSpecial(val)) return;
          el.setAttribute(attr, makeAbs(val));
        });
      }

      function setTitleFromFirstHeading(html) {
        // Extract first markdown heading text for <title>
        const tmp = document.createElement('div');
        tmp.innerHTML = html;
        const h1 = tmp.querySelector('h1, h2');
        if (h1 && h1.textContent) {
          document.title = h1.textContent.trim();
        }
      }

      function showUsage() {
        loading.style.display = 'none';
        output.style.display = '';
        output.innerHTML = `
          <div class="text-white-50">
            <h1 class="h3 text-white">Book Viewer</h1>
            <p>Provide a Markdown file via the <code>?src=</code> query parameter.</p>
            <p class="mb-2">Examples:</p>
            <ul>
              <li><code>book-viewer.html?src=tutorial-ada.md</code></li>
              <li><code>book-viewer.html?src=tutorial-asm.md</code></li>
            </ul>
            <p class="mb-0 small">Note: The file must be accessible from the same origin (use a local web server). Relative image and link paths inside the Markdown will be resolved relative to the Markdown file's folder.</p>
          </div>`;
      }

      async function render() {
        if (!src) {
          return showUsage();
        }
        try {
          const response = await fetch(src);
          if (!response.ok) throw new Error('Failed to fetch: ' + src);
          const raw = await response.text();
          const html = md.render(raw);
          setTitleFromFirstHeading(html);
          output.innerHTML = html;
          // Rewrite relative URLs in links/images to be relative to the Markdown file's folder
          resolveRelativeUrls(output, baseDirOf(src));
          // Highlight code blocks
          document.querySelectorAll('pre code').forEach(block => {
            block.classList.add('hljs');
          });
          hljs.highlightAll();
        } catch (err) {
          console.error(err);
          output.innerHTML = '<div class="alert alert-danger">Failed to load book content.</div>';
        } finally {
          loading.style.display = 'none';
          output.style.display = '';
        }
      }

      render();
    })();
  </script>
</body>
</html>
