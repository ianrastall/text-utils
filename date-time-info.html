<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag gtag.js -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0V2F0V7FWB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0V2F0V7FWB');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Date/Time Info - Text Utilities</title>
    <script>
        (function () {
            try {
                const storedTheme = localStorage.getItem('theme');
                const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
                const resolvedTheme = storedTheme === 'light' || storedTheme === 'dark'
                    ? storedTheme
                    : (prefersLight ? 'light' : 'dark');
                document.documentElement.setAttribute('data-theme', resolvedTheme);

                const storedAccent = localStorage.getItem('accentColor');
                let normalizedAccent = typeof storedAccent === 'string' ? storedAccent.trim().toLowerCase() : '';
                if (/^#[0-9a-f]{3}$/.test(normalizedAccent)) {
                    normalizedAccent = `#${normalizedAccent[1]}${normalizedAccent[1]}${normalizedAccent[2]}${normalizedAccent[2]}${normalizedAccent[3]}${normalizedAccent[3]}`;
                }

                if (/^#[0-9a-f]{6}$/.test(normalizedAccent)) {
                    const red = parseInt(normalizedAccent.slice(1, 3), 16);
                    const green = parseInt(normalizedAccent.slice(3, 5), 16);
                    const blue = parseInt(normalizedAccent.slice(5, 7), 16);
                    document.documentElement.style.setProperty('--accent', normalizedAccent);
                    document.documentElement.style.setProperty('--accent-rgb', `${red}, ${green}, ${blue}`);
                }
            } catch (_) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .tool-grid {
            display: grid;
            grid-template-columns: 1.1fr 0.9fr;
            gap: 1.25rem;
        }
        @media (max-width: 1024px) {
            .tool-grid {
                grid-template-columns: 1fr;
            }
        }
        .panel {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
        }
        .panel h4 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }
        .option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 0.75rem;
        }
        .output-block {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            white-space: pre-wrap;
            min-height: 200px;
        }
        .small-note {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .btn-bar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .status-bar .success { color: #4caf50; }
        .status-bar .warning { color: #ff9800; }
        .status-bar .error { color: #f44336; }
        .status-bar .info { color: #2196f3; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <a href="index.html" style="color: inherit; text-decoration: none;">
                    <span>Text Utilities</span>
                </a>
            </div>
            <nav class="site-network" aria-label="Network sites">
                <a href="https://chessnerd.net" class="site-network-link" target="_blank" rel="noopener noreferrer">
                    <img src="img/chessnerd-icon.png" class="site-network-icon" alt="">
                    <span>Chess Nerd</span>
                    <span class="material-icons" aria-hidden="true">open_in_new</span>
                </a>
                <a href="https://github.com/ianrastall/text-utils" class="site-network-link" target="_blank" rel="noopener noreferrer">
                    <img src="img/github.png" class="site-network-icon" alt="">
                    <span>GitHub</span>
                    <span class="material-icons" aria-hidden="true">open_in_new</span>
                </a>
            </nav>
            <div class="controls">
                <div class="accent-selector">
                    <span class="material-icons">palette</span>
                    <select id="accentColor" class="color-dropdown" aria-label="Accent color"></select>
                </div>
                <button id="themeToggle" class="btn btn-secondary" type="button" aria-label="Toggle theme" aria-pressed="false">
                    <span class="material-icons">dark_mode</span>
                </button>
            </div>
        </header>

        <main>
            <div class="tool-container">
                <div class="tool-header">
                    <div class="tool-title">
                        <span class="material-icons">schedule</span>
                        <h2>Date/Time Info</h2>
                    </div>
                    <div class="tool-actions">
                        <button type="button" id="backButton" class="btn btn-secondary btn-compact">
                            <span class="material-icons">arrow_back</span>
                            Back
                        </button>
                        <button type="button" id="copyBtn" class="btn btn-secondary">
                            <span class="material-icons">content_copy</span>
                            Copy
                        </button>
                        <button type="button" id="refreshBtn" class="btn btn-secondary">
                            <span class="material-icons">refresh</span>
                            Refresh
                        </button>
                    </div>
                </div>

                <p class="tool-description">Inspect the current date/time (or a custom moment) across calendars, formats, and time zones.</p>

                <div class="tool-grid">
                    <div class="panel">
                        <h4><span class="material-icons" style="font-size:20px;">tune</span>Settings</h4>
                        <form id="dtForm">
                            <div class="option-grid">
                                <div class="option-group">
                                    <label for="calendarSelect">Calendar</label>
                                    <select id="calendarSelect">
                                        <option value="gregory">Gregorian</option>
                                        <option value="buddhist">Buddhist</option>
                                        <option value="chinese">Chinese</option>
                                        <option value="coptic">Coptic</option>
                                        <option value="dangi">Dangi</option>
                                        <option value="ethiopic">Ethiopic</option>
                                        <option value="ethiopic-amete-alem">Ethiopic Amete Alem</option>
                                        <option value="hebrew">Hebrew</option>
                                        <option value="islamic">Islamic (tabular)</option>
                                        <option value="islamic-umalqura">Islamic (Umm al-Qura)</option>
                                        <option value="islamic-civil">Islamic (civil)</option>
                                        <option value="islamic-rgsa">Islamic (Saudi)</option>
                                        <option value="japanese">Japanese</option>
                                        <option value="persian">Persian</option>
                                        <option value="roc">Minguo (ROC)</option>
                                        <option value="badi">Baha'i (approx, experimental)</option>
                                        <option value="indian">Indian (National)</option>
                                    </select>
                                    <p class="small-note">Some calendars depend on browser Intl support and may fall back to Gregorian. Baha'i uses a fixed March 21 rule before 2015 and an official Naw-Ruz date table for 2015-2064; day boundaries are still approximate.</p>
                                </div>
                                <div class="option-group">
                                    <label for="timeFormatSelect">Time Format</label>
                                    <select id="timeFormatSelect">
                                        <option value="24h">24-hour</option>
                                        <option value="12h">12-hour AM/PM</option>
                                        <option value="iso">ISO 8601</option>
                                        <option value="rfc">RFC 2822</option>
                                        <option value="unix">Unix Timestamp</option>
                                        <option value="utc">UTC (Zulu)</option>
                                        <option value="julian">Julian Date (instant)</option>
                                    </select>
                                </div>
                                <div class="option-group">
                                    <label for="timezoneSelect">Time Zone</label>
                                    <select id="timezoneSelect">
                                        <option value="local">Auto (browser time zone)</option>
                                        <option value="UTC">UTC</option>
                                        <option value="America/New_York">America/New_York</option>
                                        <option value="America/Chicago">America/Chicago</option>
                                        <option value="America/Denver">America/Denver</option>
                                        <option value="America/Los_Angeles">America/Los_Angeles</option>
                                        <option value="America/Phoenix">America/Phoenix</option>
                                        <option value="America/Anchorage">America/Anchorage</option>
                                        <option value="Pacific/Honolulu">Pacific/Honolulu</option>
                                        <option value="Europe/London">Europe/London</option>
                                        <option value="Europe/Paris">Europe/Paris</option>
                                        <option value="Europe/Berlin">Europe/Berlin</option>
                                        <option value="Europe/Moscow">Europe/Moscow</option>
                                        <option value="Africa/Cairo">Africa/Cairo</option>
                                        <option value="Africa/Johannesburg">Africa/Johannesburg</option>
                                        <option value="Asia/Jerusalem">Asia/Jerusalem</option>
                                        <option value="Asia/Dubai">Asia/Dubai</option>
                                        <option value="Asia/Kolkata">Asia/Kolkata</option>
                                        <option value="Asia/Bangkok">Asia/Bangkok</option>
                                        <option value="Asia/Shanghai">Asia/Shanghai</option>
                                        <option value="Asia/Tokyo">Asia/Tokyo</option>
                                        <option value="Asia/Seoul">Asia/Seoul</option>
                                        <option value="Australia/Sydney">Australia/Sydney</option>
                                        <option value="Pacific/Auckland">Pacific/Auckland</option>
                                    </select>
                                </div>
                                <div class="option-group">
                                    <label for="customDateTime">Custom Date/Time (optional)</label>
                                    <input type="datetime-local" id="customDateTime">
                                    <p class="small-note">If blank, the current moment is used. Entered time is interpreted as your browser's local time; the Time Zone setting controls how that moment is displayed.</p>
                                </div>
                            </div>
                            <div class="btn-bar" style="margin-top:0.75rem;">
                                <button type="submit" class="btn btn-primary">
                                    <span class="material-icons">play_arrow</span>
                                    Generate
                                </button>
                                <button type="button" id="useNowBtn" class="btn btn-secondary">
                                    <span class="material-icons">schedule</span>
                                    Use Now
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="panel" style="display:flex; flex-direction:column; gap:0.75rem;">
                        <div>
                            <h4><span class="material-icons" style="font-size:20px;">code</span>Formatted Output</h4>
                            <div id="outputBlock" class="output-block" aria-live="polite"></div>
                        </div>
                        <div class="status-bar">
                            <div id="statusMessage" class="success">Ready</div>
                            <div id="toolStats">Awaiting input</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/theme.js"></script>
    <script src="js/badi-calendar.js"></script>
    <script>
        (() => {
            'use strict';

            const dom = {};

            const calendarOptions = [
                'gregory','buddhist','chinese','coptic','dangi','ethiopic','ethiopic-amete-alem','hebrew','islamic','islamic-umalqura','islamic-civil','islamic-rgsa','japanese','persian','roc','badi','indian'
            ];
            const supportedCalendars = typeof Intl !== 'undefined' && typeof Intl.supportedValuesOf === 'function'
                ? Intl.supportedValuesOf('calendar')
                : [];
            const hasCalendarSupportList = Array.isArray(supportedCalendars) && supportedCalendars.length > 0;
            const badiCalendar = (typeof window !== 'undefined' && window.TextUtilsBadiCalendar) || null;
            const badiCalendarConsts = (badiCalendar && badiCalendar.constants) || {};
            const BADI_TABLE_FIRST_YEAR_GREGORIAN = Number.isInteger(badiCalendarConsts.BADI_TABLE_FIRST_YEAR_GREGORIAN)
                ? badiCalendarConsts.BADI_TABLE_FIRST_YEAR_GREGORIAN
                : 2015;
            const BADI_TABLE_LAST_YEAR_GREGORIAN = Number.isInteger(badiCalendarConsts.BADI_TABLE_LAST_YEAR_GREGORIAN)
                ? badiCalendarConsts.BADI_TABLE_LAST_YEAR_GREGORIAN
                : 2064;
            const nawruzUTC = badiCalendar && typeof badiCalendar.nawruzUTC === 'function'
                ? badiCalendar.nawruzUTC
                : null;
            const badiFromGregorian = badiCalendar && typeof badiCalendar.badiFromGregorian === 'function'
                ? badiCalendar.badiFromGregorian
                : null;
            const runBadiSelfTests = badiCalendar && typeof badiCalendar.runSelfTests === 'function'
                ? badiCalendar.runSelfTests
                : null;

            const setStatus = (msg, type = 'success') => {
                dom.status.textContent = msg;
                dom.status.className = type;
            };

            const buildRenderFeedback = ({
                code,
                useBadi = false,
                displayCalendar = 'gregory',
                fallbackUsed = false,
                timeFormat = '24h',
                timeZone = 'local',
                tz = 'UTC',
                badiRangeWarning = false
            }) => {
                if (code === 'intl_unsupported') {
                    return {
                        statusText: 'Intl features unavailable in this browser',
                        statusType: 'error',
                        statsText: 'Intl.DateTimeFormat unavailable'
                    };
                }

                const zoneLabel = timeZone === 'local' ? `${tz} (auto from your browser)` : tz;
                const calendarLabel = useBadi
                    ? `Badíʿ (${badiRangeWarning ? 'range-limited' : 'approx'})`
                    : `${displayCalendar}${fallbackUsed ? ' (fallback)' : ''}`;

                let statusText = 'Updated.';
                let statusType = 'success';

                switch (code) {
                    case 'badi_ok':
                        statusText = 'Badíʿ values use a table-driven Naw-Rúz source (official 2015-2064; earlier years use the historical fixed March 21 rule). Day boundaries remain approximate.';
                        statusType = 'info';
                        break;
                    case 'badi_range_warning':
                        statusText = 'Badíʿ conversion is range-limited in this tool; Gregorian formatting is still shown.';
                        statusType = 'warning';
                        break;
                    case 'badi_error':
                        statusText = 'Badíʿ calculation unavailable for this date; Gregorian formatting is still shown.';
                        statusType = 'warning';
                        break;
                    case 'calendar_fallback':
                        statusText = 'Your browser cannot format this calendar. Displaying Gregorian dates.';
                        statusType = 'warning';
                        break;
                    case 'format_fallback_intl':
                        statusText = 'Browser formatting for this calendar is unavailable. Showing Gregorian dates.';
                        statusType = 'warning';
                        break;
                    case 'format_fallback_unexpected':
                        statusText = 'Unexpected formatting error. Showing Gregorian dates.';
                        statusType = 'error';
                        break;
                    default:
                        break;
                }

                return {
                    statusText,
                    statusType,
                    statsText: `Calendar ${calendarLabel}, ${timeFormat} format, ${zoneLabel}`
                };
            };

            const applyRenderFeedback = (state) => {
                const feedback = buildRenderFeedback(state);
                setStatus(feedback.statusText, feedback.statusType);
                dom.toolStats.textContent = feedback.statsText;
            };

            const toJulianDate = (date) => {
                // Julian Date for the exact UTC instant represented by `date`
                const t = date.getTime(); // ms since epoch UTC
                return t / 86400000 + 2440587.5;
            };

            const buildFormats = (dt, opts) => {
                const { calendar, timeZone, timeFormat } = opts;
                const tz = timeZone === 'local' ? Intl.DateTimeFormat().resolvedOptions().timeZone : timeZone;
                const baseOpts = { calendar, timeZone: tz, hour: 'numeric', minute: 'numeric', second: 'numeric' };

                const formatter24 = new Intl.DateTimeFormat('en', { ...baseOpts, hour12: false, year: 'numeric', month: 'long', day: 'numeric' });
                const formatter12 = new Intl.DateTimeFormat('en', { ...baseOpts, hour12: true, year: 'numeric', month: 'long', day: 'numeric' });
                const formatterDateOnly = new Intl.DateTimeFormat('en', { ...baseOpts, hour: undefined, minute: undefined, second: undefined, year: 'numeric', month: 'long', day: 'numeric' });

                const iso = dt.toISOString();
                const rfc = dt.toUTCString();
                const unix = Math.floor(dt.getTime() / 1000);
                const julian = toJulianDate(dt).toFixed(5);

                const parts = {
                    '24h': formatter24.format(dt),
                    '12h': formatter12.format(dt),
                    'iso': iso,
                    'rfc': rfc,
                    'unix': unix,
                    'utc': dt.toISOString().replace('T', ' ').replace('Z', ' UTC'),
                    'julian': julian,
                    dateOnly: formatterDateOnly.format(dt),
                };

                return { parts, tz };
            };

            const resolveDate = () => {
                const val = dom.customDateTime.value;
                if (!val) return new Date();
                const parsed = new Date(val);
                return isNaN(parsed.getTime()) ? new Date() : parsed;
            };

            const render = () => {
                if (typeof Intl === 'undefined' || !Intl.DateTimeFormat) {
                    dom.outputBlock.textContent = 'Your browser does not support the internationalization features required for this tool. Try a modern browser such as Firefox, Chrome, or Edge (some in-app mobile browsers may not work).';
                    applyRenderFeedback({ code: 'intl_unsupported' });
                    return;
                }

                const calendar = dom.calendarSelect.value;
                const timeFormat = dom.timeFormatSelect.value;
                const timeZone = dom.timezoneSelect.value;
                const dtInput = resolveDate();
                const zonedDate = dtInput;

                const useBadi = calendar === 'badi';
                const effectiveCalendar = useBadi ? 'gregory' : calendar;

                let displayCalendar = effectiveCalendar;
                let fallbackUsed = false;
                if (!useBadi && hasCalendarSupportList && !supportedCalendars.includes(effectiveCalendar)) {
                    displayCalendar = 'gregory';
                    fallbackUsed = true;
                }

                let feedbackCode = useBadi ? 'badi_ok' : (fallbackUsed ? 'calendar_fallback' : 'updated');
                let badiRangeWarning = false;
                let formats;
                try {
                    formats = buildFormats(zonedDate, { calendar: displayCalendar, timeZone, timeFormat });
                } catch (err) {
                    console.error('Date/Time Info format fallback:', err);
                    formats = buildFormats(zonedDate, { calendar: 'gregory', timeZone, timeFormat });
                    displayCalendar = 'gregory';
                    fallbackUsed = true;
                    const isLikelyIntlRangeError = err instanceof RangeError;
                    feedbackCode = isLikelyIntlRangeError ? 'format_fallback_intl' : 'format_fallback_unexpected';
                }

                const { parts, tz } = formats;
                const lines = [
                    `Calendar: ${calendar}${fallbackUsed && !useBadi ? ' (not supported; showing Gregorian)' : ''}`,
                    `Time Zone: ${timeZone === 'local' ? `${tz} (auto from your browser)` : tz}`,
                    `Date (long): ${parts.dateOnly}`,
                    `Time (${timeFormat}): ${parts[timeFormat] ?? parts['24h']}`,
                    `ISO 8601: ${parts.iso}`,
                    `RFC 2822: ${parts.rfc}`,
                    `Unix Timestamp: ${parts.unix}`,
                    `Julian Date (instant): ${parts.julian}`
                ];

                if (useBadi) {
                    if (!badiFromGregorian) {
                        lines.push('Badíʿ calendar: support module failed to load (`js/badi-calendar.js`).');
                        feedbackCode = 'badi_error';
                    } else {
                    try {
                        const badi = badiFromGregorian(dtInput);
                        lines.push(
                            `Badíʿ (table + legacy rule; day-boundary approx): Year ${badi.yearBE} B.E., ${badi.label}`,
                            `Intercalary days this year: ${badi.ayyamiHaDays}`
                        );
                    } catch (err) {
                        console.error('Date/Time Info Badíʿ calculation error:', err);
                        if (err instanceof RangeError) {
                            lines.push(`Badíʿ calendar: ${err.message}`);
                            lines.push(`Badíʿ note: This tool uses a fixed March 21 rule before ${BADI_TABLE_FIRST_YEAR_GREGORIAN} and an official Naw-Rúz date table for ${BADI_TABLE_FIRST_YEAR_GREGORIAN}-${BADI_TABLE_LAST_YEAR_GREGORIAN}.`);
                            feedbackCode = 'badi_range_warning';
                            badiRangeWarning = true;
                        } else {
                            lines.push('Badíʿ calendar: unavailable due to a calculation error.');
                            feedbackCode = 'badi_error';
                        }
                    }
                    }
                }

                dom.outputBlock.textContent = lines.join('\n');
                applyRenderFeedback({
                    code: feedbackCode,
                    useBadi,
                    displayCalendar,
                    fallbackUsed,
                    timeFormat,
                    timeZone,
                    tz,
                    badiRangeWarning
                });
            };

            const copyOutput = async () => {
                const text = dom.outputBlock.textContent.trim();
                if (!text) {
                    setStatus('Nothing to copy.', 'warning');
                    return;
                }
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(text);
                        setStatus('Copied.', 'success');
                        return;
                    }

                    if (typeof window.textUtilsClipboardWrite === 'function') {
                        await window.textUtilsClipboardWrite(text);
                        setStatus('Copied.', 'success');
                        return;
                    }

                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.setAttribute('readonly', '');
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    const ok = typeof document.execCommand === 'function' && document.execCommand('copy');
                    document.body.removeChild(textarea);
                    setStatus(
                        ok ? 'Copied (legacy fallback).' : 'Copy not supported in this browser. Select the output and press Ctrl+C / Cmd+C.',
                        ok ? 'success' : 'warning'
                    );
                } catch (err) {
                    const message = err && err.message ? err.message : 'Unknown error';
                    setStatus(`Copy failed: ${message}`, 'error');
                }
            };

            const useNow = () => {
                dom.customDateTime.value = '';
                render();
            };

            const cacheDom = () => {
                dom.calendarSelect = document.getElementById('calendarSelect');
                dom.timeFormatSelect = document.getElementById('timeFormatSelect');
                dom.timezoneSelect = document.getElementById('timezoneSelect');
                dom.customDateTime = document.getElementById('customDateTime');
                dom.outputBlock = document.getElementById('outputBlock');
                dom.status = document.getElementById('statusMessage');
                dom.toolStats = document.getElementById('toolStats');
                dom.copyBtn = document.getElementById('copyBtn');
                dom.refreshBtn = document.getElementById('refreshBtn');
                dom.useNowBtn = document.getElementById('useNowBtn');
                dom.backButton = document.getElementById('backButton');
                dom.form = document.getElementById('dtForm');
            };

            const init = () => {
                cacheDom();
                window.__dateTimeInfoBadi = badiCalendar || {
                    error: 'js/badi-calendar.js failed to load'
                };
                dom.form.addEventListener('submit', (e) => { e.preventDefault(); render(); });
                dom.calendarSelect.addEventListener('change', render);
                dom.timeFormatSelect.addEventListener('change', render);
                dom.timezoneSelect.addEventListener('change', render);
                dom.customDateTime.addEventListener('change', render);
                dom.copyBtn.addEventListener('click', copyOutput);
                dom.refreshBtn.addEventListener('click', render);
                dom.useNowBtn.addEventListener('click', useNow);
                dom.backButton.addEventListener('click', () => {
                    if (window.history.length > 1) {
                        window.history.back();
                        return;
                    }
                    window.location.href = 'index.html';
                });
                if (new URLSearchParams(window.location.search).get('selftest') === '1') {
                    if (typeof runBadiSelfTests === 'function') {
                        try {
                            const result = runBadiSelfTests();
                            console.info('Date/Time Info Badíʿ self-tests passed.', result);
                        } catch (err) {
                            console.error('Date/Time Info Badíʿ self-tests failed.', err);
                        }
                    } else {
                        console.error('Date/Time Info Badíʿ self-tests unavailable: js/badi-calendar.js was not loaded.');
                    }
                }
                render();
            };

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
    <footer class="site-footer">
        <p>&copy; Ian Rastall 2025<br>Contact: moving.form.of.dust@gmail.com<br>Donate: PayPal to merastall@gmail.com</p>
    </footer>
</body>
</html>
