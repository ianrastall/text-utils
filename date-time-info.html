<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag gtag.js -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0V2F0V7FWB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0V2F0V7FWB');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Date/Time Info - Text Utilities</title>
    <script>
        (function () {
            try {
                const storedTheme = localStorage.getItem('theme');
                const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
                const resolvedTheme = storedTheme === 'light' || storedTheme === 'dark'
                    ? storedTheme
                    : (prefersLight ? 'light' : 'dark');
                document.documentElement.setAttribute('data-theme', resolvedTheme);

                const storedAccent = localStorage.getItem('accentColor');
                let normalizedAccent = typeof storedAccent === 'string' ? storedAccent.trim().toLowerCase() : '';
                if (/^#[0-9a-f]{3}$/.test(normalizedAccent)) {
                    normalizedAccent = `#${normalizedAccent[1]}${normalizedAccent[1]}${normalizedAccent[2]}${normalizedAccent[2]}${normalizedAccent[3]}${normalizedAccent[3]}`;
                }

                if (/^#[0-9a-f]{6}$/.test(normalizedAccent)) {
                    const red = parseInt(normalizedAccent.slice(1, 3), 16);
                    const green = parseInt(normalizedAccent.slice(3, 5), 16);
                    const blue = parseInt(normalizedAccent.slice(5, 7), 16);
                    document.documentElement.style.setProperty('--accent', normalizedAccent);
                    document.documentElement.style.setProperty('--accent-rgb', `${red}, ${green}, ${blue}`);
                }
            } catch (_) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .tool-grid {
            display: grid;
            grid-template-columns: 1.1fr 0.9fr;
            gap: 1.25rem;
        }
        @media (max-width: 1024px) {
            .tool-grid {
                grid-template-columns: 1fr;
            }
        }
        .panel {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
        }
        .panel h4 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }
        .option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 0.75rem;
        }
        .output-block {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            white-space: pre-wrap;
            min-height: 200px;
        }
        .small-note {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .btn-bar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .status-bar .success { color: #4caf50; }
        .status-bar .warning { color: #ff9800; }
        .status-bar .error { color: #f44336; }
        .status-bar .info { color: #2196f3; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <a href="index.html" style="color: inherit; text-decoration: none;">
                    <span>Text Utilities</span>
                </a>
            </div>
            <nav class="site-network" aria-label="Network sites">
                <a href="https://chessnerd.net" class="site-network-link" target="_blank" rel="noopener noreferrer">
                    <img src="img/chessnerd-icon.png" class="site-network-icon" alt="">
                    <span>Chess Nerd</span>
                    <span class="material-icons" aria-hidden="true">open_in_new</span>
                </a>
                <a href="https://github.com/ianrastall/text-utils" class="site-network-link" target="_blank" rel="noopener noreferrer">
                    <img src="img/github.png" class="site-network-icon" alt="">
                    <span>GitHub</span>
                    <span class="material-icons" aria-hidden="true">open_in_new</span>
                </a>
            </nav>
            <div class="controls">
                <div class="accent-selector">
                    <span class="material-icons">palette</span>
                    <select id="accentColor" class="color-dropdown" aria-label="Accent color"></select>
                </div>
                <button id="themeToggle" class="btn btn-secondary" type="button" aria-label="Toggle theme" aria-pressed="false">
                    <span class="material-icons">dark_mode</span>
                </button>
            </div>
        </header>

        <main>
            <div class="tool-container">
                <div class="tool-header">
                    <div class="tool-title">
                        <span class="material-icons">schedule</span>
                        <h2>Date/Time Info</h2>
                    </div>
                    <div class="tool-actions">
                        <button type="button" id="backButton" class="btn btn-secondary btn-compact">
                            <span class="material-icons">arrow_back</span>
                            Back
                        </button>
                        <button type="button" id="copyBtn" class="btn btn-secondary">
                            <span class="material-icons">content_copy</span>
                            Copy
                        </button>
                        <button type="button" id="refreshBtn" class="btn btn-secondary">
                            <span class="material-icons">refresh</span>
                            Refresh
                        </button>
                    </div>
                </div>

                <p class="tool-description">Inspect the current date/time (or a custom moment) across calendars, formats, and time zones.</p>

                <div class="tool-grid">
                    <div class="panel">
                        <h4><span class="material-icons" style="font-size:20px;">tune</span>Settings</h4>
                        <form id="dtForm">
                            <div class="option-grid">
                                <div class="option-group">
                                    <label for="calendarSelect">Calendar</label>
                                    <select id="calendarSelect">
                                        <option value="gregory">Gregorian</option>
                                        <option value="buddhist">Buddhist</option>
                                        <option value="chinese">Chinese</option>
                                        <option value="coptic">Coptic</option>
                                        <option value="dangi">Dangi</option>
                                        <option value="ethiopic">Ethiopic</option>
                                        <option value="ethiopic-amete-alem">Ethiopic Amete Alem</option>
                                        <option value="hebrew">Hebrew</option>
                                        <option value="islamic">Islamic (tabular)</option>
                                        <option value="islamic-umalqura">Islamic (Umm al-Qura)</option>
                                        <option value="islamic-civil">Islamic (civil)</option>
                                        <option value="islamic-rgsa">Islamic (Saudi)</option>
                                        <option value="japanese">Japanese</option>
                                        <option value="persian">Persian</option>
                                        <option value="roc">Minguo (ROC)</option>
                                        <option value="badi">Baha'i (approx, experimental)</option>
                                        <option value="indian">Indian (National)</option>
                                    </select>
                                    <p class="small-note">Some calendars depend on browser Intl support and may fall back to Gregorian. Baha'i uses a fixed March 21 rule before 2015 and an official Naw-Ruz date table for 2015-2064; day boundaries are still approximate.</p>
                                </div>
                                <div class="option-group">
                                    <label for="timeFormatSelect">Time Format</label>
                                    <select id="timeFormatSelect">
                                        <option value="24h">24-hour</option>
                                        <option value="12h">12-hour AM/PM</option>
                                        <option value="iso">ISO 8601</option>
                                        <option value="rfc">RFC 2822</option>
                                        <option value="unix">Unix Timestamp</option>
                                        <option value="utc">UTC (Zulu)</option>
                                        <option value="julian">Julian Date (instant)</option>
                                    </select>
                                </div>
                                <div class="option-group">
                                    <label for="timezoneSelect">Time Zone</label>
                                    <select id="timezoneSelect">
                                        <option value="local">Auto (browser time zone)</option>
                                        <option value="UTC">UTC</option>
                                        <option value="America/New_York">America/New_York</option>
                                        <option value="America/Chicago">America/Chicago</option>
                                        <option value="America/Denver">America/Denver</option>
                                        <option value="America/Los_Angeles">America/Los_Angeles</option>
                                        <option value="America/Phoenix">America/Phoenix</option>
                                        <option value="America/Anchorage">America/Anchorage</option>
                                        <option value="Pacific/Honolulu">Pacific/Honolulu</option>
                                        <option value="Europe/London">Europe/London</option>
                                        <option value="Europe/Paris">Europe/Paris</option>
                                        <option value="Europe/Berlin">Europe/Berlin</option>
                                        <option value="Europe/Moscow">Europe/Moscow</option>
                                        <option value="Africa/Cairo">Africa/Cairo</option>
                                        <option value="Africa/Johannesburg">Africa/Johannesburg</option>
                                        <option value="Asia/Jerusalem">Asia/Jerusalem</option>
                                        <option value="Asia/Dubai">Asia/Dubai</option>
                                        <option value="Asia/Kolkata">Asia/Kolkata</option>
                                        <option value="Asia/Bangkok">Asia/Bangkok</option>
                                        <option value="Asia/Shanghai">Asia/Shanghai</option>
                                        <option value="Asia/Tokyo">Asia/Tokyo</option>
                                        <option value="Asia/Seoul">Asia/Seoul</option>
                                        <option value="Australia/Sydney">Australia/Sydney</option>
                                        <option value="Pacific/Auckland">Pacific/Auckland</option>
                                    </select>
                                </div>
                                <div class="option-group">
                                    <label for="customDateTime">Custom Date/Time (optional)</label>
                                    <input type="datetime-local" id="customDateTime">
                                    <p class="small-note">If blank, the current moment is used. Entered time is interpreted as your browser's local time; the Time Zone setting controls how that moment is displayed.</p>
                                </div>
                            </div>
                            <div class="btn-bar" style="margin-top:0.75rem;">
                                <button type="submit" class="btn btn-primary">
                                    <span class="material-icons">play_arrow</span>
                                    Generate
                                </button>
                                <button type="button" id="useNowBtn" class="btn btn-secondary">
                                    <span class="material-icons">schedule</span>
                                    Use Now
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="panel" style="display:flex; flex-direction:column; gap:0.75rem;">
                        <div>
                            <h4><span class="material-icons" style="font-size:20px;">code</span>Formatted Output</h4>
                            <div id="outputBlock" class="output-block" aria-live="polite"></div>
                        </div>
                        <div class="status-bar">
                            <div id="statusMessage" class="success">Ready</div>
                            <div id="toolStats">Awaiting input</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/theme.js"></script>
    <script>
        (() => {
            'use strict';

            const dom = {};

            const calendarOptions = [
                'gregory','buddhist','chinese','coptic','dangi','ethiopic','ethiopic-amete-alem','hebrew','islamic','islamic-umalqura','islamic-civil','islamic-rgsa','japanese','persian','roc','badi','indian'
            ];
            const supportedCalendars = typeof Intl !== 'undefined' && typeof Intl.supportedValuesOf === 'function'
                ? Intl.supportedValuesOf('calendar')
                : [];
            const hasCalendarSupportList = Array.isArray(supportedCalendars) && supportedCalendars.length > 0;
            const BADI_FIRST_YEAR_GREGORIAN = 1844;
            const BADI_TABLE_FIRST_YEAR_GREGORIAN = 2015; // 172 B.E.
            const BADI_TABLE_LAST_YEAR_GREGORIAN = 2064;  // 221 B.E. Naw-Rúz boundary; next Naw-Rúz not in official table
            const TEHRAN_FIXED_OFFSET_MS = 3.5 * 3600 * 1000;

            const setStatus = (msg, type = 'success') => {
                dom.status.textContent = msg;
                dom.status.className = type;
            };

            const buildRenderFeedback = ({
                code,
                useBadi = false,
                displayCalendar = 'gregory',
                fallbackUsed = false,
                timeFormat = '24h',
                timeZone = 'local',
                tz = 'UTC',
                badiRangeWarning = false
            }) => {
                if (code === 'intl_unsupported') {
                    return {
                        statusText: 'Intl features unavailable in this browser',
                        statusType: 'error',
                        statsText: 'Intl.DateTimeFormat unavailable'
                    };
                }

                const zoneLabel = timeZone === 'local' ? `${tz} (auto from your browser)` : tz;
                const calendarLabel = useBadi
                    ? `Badíʿ (${badiRangeWarning ? 'range-limited' : 'approx'})`
                    : `${displayCalendar}${fallbackUsed ? ' (fallback)' : ''}`;

                let statusText = 'Updated.';
                let statusType = 'success';

                switch (code) {
                    case 'badi_ok':
                        statusText = 'Badíʿ values use a table-driven Naw-Rúz source (official 2015-2064; earlier years use the historical fixed March 21 rule). Day boundaries remain approximate.';
                        statusType = 'info';
                        break;
                    case 'badi_range_warning':
                        statusText = 'Badíʿ conversion is range-limited in this tool; Gregorian formatting is still shown.';
                        statusType = 'warning';
                        break;
                    case 'badi_error':
                        statusText = 'Badíʿ calculation unavailable for this date; Gregorian formatting is still shown.';
                        statusType = 'warning';
                        break;
                    case 'calendar_fallback':
                        statusText = 'Your browser cannot format this calendar. Displaying Gregorian dates.';
                        statusType = 'warning';
                        break;
                    case 'format_fallback_intl':
                        statusText = 'Browser formatting for this calendar is unavailable. Showing Gregorian dates.';
                        statusType = 'warning';
                        break;
                    case 'format_fallback_unexpected':
                        statusText = 'Unexpected formatting error. Showing Gregorian dates.';
                        statusType = 'error';
                        break;
                    default:
                        break;
                }

                return {
                    statusText,
                    statusType,
                    statsText: `Calendar ${calendarLabel}, ${timeFormat} format, ${zoneLabel}`
                };
            };

            const applyRenderFeedback = (state) => {
                const feedback = buildRenderFeedback(state);
                setStatus(feedback.statusText, feedback.statusType);
                dom.toolStats.textContent = feedback.statsText;
            };

            const toJulianDate = (date) => {
                // Julian Date for the exact UTC instant represented by `date`
                const t = date.getTime(); // ms since epoch UTC
                return t / 86400000 + 2440587.5;
            };

            // --- Badíʿ calendar (table-driven Naw-Rúz dates + pre-2015 fixed rule) ---
            // 2015-2064 Naw-Rúz dates are from the Bahá'í World Centre "Bahá'í Dates 172 to 221 B.E." table.
            // We model Naw-Rúz as the start of the listed Tehran civil day. Sunset boundaries are not modeled,
            // so sub-day results remain approximate near sunset.
            const BADI_NAWRUZ_TABLE_2015_2064 = Object.freeze({
                2015: '2015-03-21', // 172 B.E.
                2016: '2016-03-20', // 173 B.E.
                2017: '2017-03-20', // 174 B.E.
                2018: '2018-03-21', // 175 B.E.
                2019: '2019-03-21', // 176 B.E.
                2020: '2020-03-20', // 177 B.E.
                2021: '2021-03-20', // 178 B.E.
                2022: '2022-03-21', // 179 B.E.
                2023: '2023-03-21', // 180 B.E.
                2024: '2024-03-20', // 181 B.E.
                2025: '2025-03-20', // 182 B.E.
                2026: '2026-03-21', // 183 B.E.
                2027: '2027-03-21', // 184 B.E.
                2028: '2028-03-20', // 185 B.E.
                2029: '2029-03-20', // 186 B.E.
                2030: '2030-03-20', // 187 B.E.
                2031: '2031-03-21', // 188 B.E.
                2032: '2032-03-20', // 189 B.E.
                2033: '2033-03-20', // 190 B.E.
                2034: '2034-03-20', // 191 B.E.
                2035: '2035-03-21', // 192 B.E.
                2036: '2036-03-20', // 193 B.E.
                2037: '2037-03-20', // 194 B.E.
                2038: '2038-03-20', // 195 B.E.
                2039: '2039-03-21', // 196 B.E.
                2040: '2040-03-20', // 197 B.E.
                2041: '2041-03-20', // 198 B.E.
                2042: '2042-03-20', // 199 B.E.
                2043: '2043-03-21', // 200 B.E.
                2044: '2044-03-20', // 201 B.E.
                2045: '2045-03-20', // 202 B.E.
                2046: '2046-03-20', // 203 B.E.
                2047: '2047-03-21', // 204 B.E.
                2048: '2048-03-20', // 205 B.E.
                2049: '2049-03-20', // 206 B.E.
                2050: '2050-03-20', // 207 B.E.
                2051: '2051-03-21', // 208 B.E.
                2052: '2052-03-20', // 209 B.E.
                2053: '2053-03-20', // 210 B.E.
                2054: '2054-03-20', // 211 B.E.
                2055: '2055-03-21', // 212 B.E.
                2056: '2056-03-20', // 213 B.E.
                2057: '2057-03-20', // 214 B.E.
                2058: '2058-03-20', // 215 B.E.
                2059: '2059-03-21', // 216 B.E.
                2060: '2060-03-20', // 217 B.E.
                2061: '2061-03-20', // 218 B.E.
                2062: '2062-03-20', // 219 B.E.
                2063: '2063-03-21', // 220 B.E.
                2064: '2064-03-20'  // 221 B.E. boundary (used to support dates before this Naw-Rúz)
            });

            const tehranCivilMidnightUtcMs = (year, month1Based, day) =>
                Date.UTC(year, month1Based - 1, day, 0, 0, 0) - TEHRAN_FIXED_OFFSET_MS;

            const toYmdFromTehranDayBoundary = (utcMs) => {
                const d = new Date(utcMs + TEHRAN_FIXED_OFFSET_MS);
                return `${d.getUTCFullYear()}-${String(d.getUTCMonth() + 1).padStart(2, '0')}-${String(d.getUTCDate()).padStart(2, '0')}`;
            };

            const nawruzUTC = (gregorianYear) => {
                if (!Number.isInteger(gregorianYear)) {
                    throw new TypeError('Gregorian year must be an integer.');
                }
                if (gregorianYear < BADI_FIRST_YEAR_GREGORIAN) {
                    throw new RangeError(`Badíʿ dates are supported from Naw-Rúz ${BADI_FIRST_YEAR_GREGORIAN}-03-21 onward.`);
                }

                if (gregorianYear < BADI_TABLE_FIRST_YEAR_GREGORIAN) {
                    // Historical fixed-rule practice prior to the 2015 reform.
                    return tehranCivilMidnightUtcMs(gregorianYear, 3, 21);
                }

                const ymd = BADI_NAWRUZ_TABLE_2015_2064[gregorianYear];
                if (!ymd) {
                    throw new RangeError(`Badíʿ table-driven Naw-Rúz dates are available through ${BADI_TABLE_LAST_YEAR_GREGORIAN}-03-20.`);
                }

                const [year, month, day] = ymd.split('-').map(Number);
                return tehranCivilMidnightUtcMs(year, month, day);
            };

            const badiFromGregorian = (instant) => {
                const t = instant.getTime();
                const gYear = instant.getUTCFullYear();
                let start = nawruzUTC(gYear);
                let badiYearGregorian = gYear;

                if (t < start) {
                    badiYearGregorian -= 1;
                    start = nawruzUTC(badiYearGregorian);
                }

                // 221 B.E. (Naw-Rúz 2064) is present only as an upper boundary marker; the official table in this tool
                // does not include the next Naw-Rúz needed to compute the rest of that year.
                if (badiYearGregorian >= BADI_TABLE_LAST_YEAR_GREGORIAN) {
                    throw new RangeError('Badíʿ conversion is supported through the start of 221 B.E. (Naw-Rúz 2064-03-20).');
                }

                const nextStart = nawruzUTC(badiYearGregorian + 1);
                const totalDays = Math.round((nextStart - start) / 86400000);
                const ayyamiHaDays = totalDays - 361; // 4 or 5 based on consecutive Naw-Rúz starts
                const dayOfYear = Math.floor((t - start) / 86400000) + 1; // 1-based

                const monthNames = [
                    'Bahá', 'Jalál', 'Jamál', '‘Aẓamat', 'Núr', 'Raḥmat', 'Kalimát', 'Kamál', 'Asmá’', '‘Izzat',
                    'Mashíyyat', '‘Ilm', 'Qudrat', 'Qawl', 'Masá’il', 'Sharaf', 'Sulṭán', 'Mulk', '‘Alá’'
                ];

                const coreMonthsDays = 19 * 18;
                let section = 'month';
                let month = 0;
                let day = 0;
                if (dayOfYear <= coreMonthsDays) {
                    month = Math.floor((dayOfYear - 1) / 19) + 1;
                    day = ((dayOfYear - 1) % 19) + 1;
                } else if (dayOfYear <= coreMonthsDays + ayyamiHaDays) {
                    section = 'ayyamiha';
                    day = dayOfYear - coreMonthsDays;
                } else {
                    month = 19;
                    day = dayOfYear - (coreMonthsDays + ayyamiHaDays);
                }

                const yearBE = badiYearGregorian - 1844 + 1;
                const label = section === 'ayyamiha'
                    ? `Ayyám-i-Há (intercalary) day ${day} of ${ayyamiHaDays}`
                    : `Month ${month}: ${monthNames[month - 1]}, Day ${day}`;

                return { yearBE, month, day, section, label, ayyamiHaDays, nawruz: new Date(start), nawruzNext: new Date(nextStart) };
            };

            const runBadiSelfTests = () => {
                const failures = [];
                const assert = (condition, message) => { if (!condition) failures.push(message); };

                const nawruzCases = [
                    { year: 1844, ymd: '1844-03-21' },
                    { year: 2015, ymd: '2015-03-21' },
                    { year: 2024, ymd: '2024-03-20' },
                    { year: 2025, ymd: '2025-03-20' },
                    { year: 2064, ymd: '2064-03-20' }
                ];

                nawruzCases.forEach(({ year, ymd }) => {
                    try {
                        const actual = toYmdFromTehranDayBoundary(nawruzUTC(year));
                        assert(actual === ymd, `Naw-Rúz ${year} expected ${ymd}, got ${actual}`);
                    } catch (err) {
                        failures.push(`Naw-Rúz lookup failed for ${year}: ${err.message}`);
                    }
                });

                try {
                    const before = badiFromGregorian(new Date('2025-03-19T12:00:00Z'));
                    assert(before.yearBE === 181, `Expected 181 B.E. before 2025 Naw-Rúz, got ${before.yearBE}`);
                } catch (err) {
                    failures.push(`Boundary test before 2025 Naw-Rúz failed: ${err.message}`);
                }

                try {
                    const after = badiFromGregorian(new Date('2025-03-20T12:00:00Z'));
                    assert(after.yearBE === 182, `Expected 182 B.E. after 2025 Naw-Rúz, got ${after.yearBE}`);
                    assert(after.month === 1 && after.day === 1, `Expected month 1 day 1 after 2025 Naw-Rúz, got month ${after.month} day ${after.day}`);
                } catch (err) {
                    failures.push(`Boundary test after 2025 Naw-Rúz failed: ${err.message}`);
                }

                try {
                    badiFromGregorian(new Date('2064-03-20T12:00:00Z'));
                    failures.push('Expected RangeError at/after 221 B.E. boundary, but conversion succeeded.');
                } catch (err) {
                    assert(err instanceof RangeError, `Expected RangeError at boundary, got ${err?.name || typeof err}`);
                }

                if (failures.length) {
                    throw new Error(`Badíʿ self-tests failed: ${failures.join(' | ')}`);
                }

                return { ok: true, checked: nawruzCases.length + 3 };
            };

            const buildFormats = (dt, opts) => {
                const { calendar, timeZone, timeFormat } = opts;
                const tz = timeZone === 'local' ? Intl.DateTimeFormat().resolvedOptions().timeZone : timeZone;
                const baseOpts = { calendar, timeZone: tz, hour: 'numeric', minute: 'numeric', second: 'numeric' };

                const formatter24 = new Intl.DateTimeFormat('en', { ...baseOpts, hour12: false, year: 'numeric', month: 'long', day: 'numeric' });
                const formatter12 = new Intl.DateTimeFormat('en', { ...baseOpts, hour12: true, year: 'numeric', month: 'long', day: 'numeric' });
                const formatterDateOnly = new Intl.DateTimeFormat('en', { ...baseOpts, hour: undefined, minute: undefined, second: undefined, year: 'numeric', month: 'long', day: 'numeric' });

                const iso = dt.toISOString();
                const rfc = dt.toUTCString();
                const unix = Math.floor(dt.getTime() / 1000);
                const julian = toJulianDate(dt).toFixed(5);

                const parts = {
                    '24h': formatter24.format(dt),
                    '12h': formatter12.format(dt),
                    'iso': iso,
                    'rfc': rfc,
                    'unix': unix,
                    'utc': dt.toISOString().replace('T', ' ').replace('Z', ' UTC'),
                    'julian': julian,
                    dateOnly: formatterDateOnly.format(dt),
                };

                return { parts, tz };
            };

            const resolveDate = () => {
                const val = dom.customDateTime.value;
                if (!val) return new Date();
                const parsed = new Date(val);
                return isNaN(parsed.getTime()) ? new Date() : parsed;
            };

            const render = () => {
                if (typeof Intl === 'undefined' || !Intl.DateTimeFormat) {
                    dom.outputBlock.textContent = 'Your browser does not support the internationalization features required for this tool. Try a modern browser such as Firefox, Chrome, or Edge (some in-app mobile browsers may not work).';
                    applyRenderFeedback({ code: 'intl_unsupported' });
                    return;
                }

                const calendar = dom.calendarSelect.value;
                const timeFormat = dom.timeFormatSelect.value;
                const timeZone = dom.timezoneSelect.value;
                const dtInput = resolveDate();
                const zonedDate = dtInput;

                const useBadi = calendar === 'badi';
                const effectiveCalendar = useBadi ? 'gregory' : calendar;

                let displayCalendar = effectiveCalendar;
                let fallbackUsed = false;
                if (!useBadi && hasCalendarSupportList && !supportedCalendars.includes(effectiveCalendar)) {
                    displayCalendar = 'gregory';
                    fallbackUsed = true;
                }

                let feedbackCode = useBadi ? 'badi_ok' : (fallbackUsed ? 'calendar_fallback' : 'updated');
                let badiRangeWarning = false;
                let formats;
                try {
                    formats = buildFormats(zonedDate, { calendar: displayCalendar, timeZone, timeFormat });
                } catch (err) {
                    console.error('Date/Time Info format fallback:', err);
                    formats = buildFormats(zonedDate, { calendar: 'gregory', timeZone, timeFormat });
                    displayCalendar = 'gregory';
                    fallbackUsed = true;
                    const isLikelyIntlRangeError = err instanceof RangeError;
                    feedbackCode = isLikelyIntlRangeError ? 'format_fallback_intl' : 'format_fallback_unexpected';
                }

                const { parts, tz } = formats;
                const lines = [
                    `Calendar: ${calendar}${fallbackUsed && !useBadi ? ' (not supported; showing Gregorian)' : ''}`,
                    `Time Zone: ${timeZone === 'local' ? `${tz} (auto from your browser)` : tz}`,
                    `Date (long): ${parts.dateOnly}`,
                    `Time (${timeFormat}): ${parts[timeFormat] ?? parts['24h']}`,
                    `ISO 8601: ${parts.iso}`,
                    `RFC 2822: ${parts.rfc}`,
                    `Unix Timestamp: ${parts.unix}`,
                    `Julian Date (instant): ${parts.julian}`
                ];

                if (useBadi) {
                    try {
                        const badi = badiFromGregorian(dtInput);
                        lines.push(
                            `Badíʿ (table + legacy rule; day-boundary approx): Year ${badi.yearBE} B.E., ${badi.label}`,
                            `Intercalary days this year: ${badi.ayyamiHaDays}`
                        );
                    } catch (err) {
                        console.error('Date/Time Info Badíʿ calculation error:', err);
                        if (err instanceof RangeError) {
                            lines.push(`Badíʿ calendar: ${err.message}`);
                            lines.push(`Badíʿ note: This tool uses a fixed March 21 rule before ${BADI_TABLE_FIRST_YEAR_GREGORIAN} and an official Naw-Rúz date table for ${BADI_TABLE_FIRST_YEAR_GREGORIAN}-${BADI_TABLE_LAST_YEAR_GREGORIAN}.`);
                            feedbackCode = 'badi_range_warning';
                            badiRangeWarning = true;
                        } else {
                            lines.push('Badíʿ calendar: unavailable due to a calculation error.');
                            feedbackCode = 'badi_error';
                        }
                    }
                }

                dom.outputBlock.textContent = lines.join('\n');
                applyRenderFeedback({
                    code: feedbackCode,
                    useBadi,
                    displayCalendar,
                    fallbackUsed,
                    timeFormat,
                    timeZone,
                    tz,
                    badiRangeWarning
                });
            };

            const copyOutput = async () => {
                const text = dom.outputBlock.textContent.trim();
                if (!text) {
                    setStatus('Nothing to copy.', 'warning');
                    return;
                }
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(text);
                        setStatus('Copied.', 'success');
                        return;
                    }

                    if (typeof window.textUtilsClipboardWrite === 'function') {
                        await window.textUtilsClipboardWrite(text);
                        setStatus('Copied.', 'success');
                        return;
                    }

                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.setAttribute('readonly', '');
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    const ok = typeof document.execCommand === 'function' && document.execCommand('copy');
                    document.body.removeChild(textarea);
                    setStatus(
                        ok ? 'Copied (legacy fallback).' : 'Copy not supported in this browser. Select the output and press Ctrl+C / Cmd+C.',
                        ok ? 'success' : 'warning'
                    );
                } catch (err) {
                    const message = err && err.message ? err.message : 'Unknown error';
                    setStatus(`Copy failed: ${message}`, 'error');
                }
            };

            const useNow = () => {
                dom.customDateTime.value = '';
                render();
            };

            const cacheDom = () => {
                dom.calendarSelect = document.getElementById('calendarSelect');
                dom.timeFormatSelect = document.getElementById('timeFormatSelect');
                dom.timezoneSelect = document.getElementById('timezoneSelect');
                dom.customDateTime = document.getElementById('customDateTime');
                dom.outputBlock = document.getElementById('outputBlock');
                dom.status = document.getElementById('statusMessage');
                dom.toolStats = document.getElementById('toolStats');
                dom.copyBtn = document.getElementById('copyBtn');
                dom.refreshBtn = document.getElementById('refreshBtn');
                dom.useNowBtn = document.getElementById('useNowBtn');
                dom.backButton = document.getElementById('backButton');
                dom.form = document.getElementById('dtForm');
            };

            const init = () => {
                cacheDom();
                window.__dateTimeInfoBadi = {
                    nawruzUTC,
                    badiFromGregorian,
                    runSelfTests: runBadiSelfTests
                };
                dom.form.addEventListener('submit', (e) => { e.preventDefault(); render(); });
                dom.calendarSelect.addEventListener('change', render);
                dom.timeFormatSelect.addEventListener('change', render);
                dom.timezoneSelect.addEventListener('change', render);
                dom.customDateTime.addEventListener('change', render);
                dom.copyBtn.addEventListener('click', copyOutput);
                dom.refreshBtn.addEventListener('click', render);
                dom.useNowBtn.addEventListener('click', useNow);
                dom.backButton.addEventListener('click', () => {
                    if (window.history.length > 1) {
                        window.history.back();
                        return;
                    }
                    window.location.href = 'index.html';
                });
                if (new URLSearchParams(window.location.search).get('selftest') === '1') {
                    try {
                        const result = runBadiSelfTests();
                        console.info('Date/Time Info Badíʿ self-tests passed.', result);
                    } catch (err) {
                        console.error('Date/Time Info Badíʿ self-tests failed.', err);
                    }
                }
                render();
            };

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
    <footer class="site-footer">
        <p>&copy; Ian Rastall 2025<br>Contact: moving.form.of.dust@gmail.com<br>Donate: PayPal to merastall@gmail.com</p>
    </footer>
</body>
</html>
